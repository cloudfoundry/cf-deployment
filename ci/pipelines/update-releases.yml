## ======================================================================
## GENERATED FILE. DO NOT EDIT
## ======================================================================

groups:
- name: update-linux-stemcell
  jobs:
  - detect-stemcell-bump
  - acquire-all-pre-dev-locks
  - update-stemcell-and-recompile-releases
  - acquire-pre-dev-lock-for-update-stemcell-minor
  - update-stemcell-minor
- name: update-base-releases
  jobs:
  - acquire-binary-buildpack-pre-dev-lock
  - update-binary-buildpack
  - acquire-bosh-dns-aliases-pre-dev-lock
  - update-bosh-dns-aliases
  - acquire-bpm-pre-dev-lock
  - update-bpm
  - acquire-capi-pre-dev-lock
  - update-capi
  - acquire-cf-networking-pre-dev-lock
  - update-cf-networking
  - acquire-cf-smoke-tests-pre-dev-lock
  - update-cf-smoke-tests
  - acquire-cf-syslog-drain-pre-dev-lock
  - update-cf-syslog-drain
  - acquire-cflinuxfs3-pre-dev-lock
  - update-cflinuxfs3
  - acquire-diego-pre-dev-lock
  - update-diego
  - acquire-dotnet-core-buildpack-pre-dev-lock
  - update-dotnet-core-buildpack
  - acquire-garden-runc-pre-dev-lock
  - update-garden-runc
  - acquire-go-buildpack-pre-dev-lock
  - update-go-buildpack
  - acquire-java-buildpack-pre-dev-lock
  - update-java-buildpack
  - acquire-log-cache-pre-dev-lock
  - update-log-cache
  - acquire-loggregator-pre-dev-lock
  - update-loggregator
  - acquire-loggregator-agent-pre-dev-lock
  - update-loggregator-agent
  - acquire-nats-pre-dev-lock
  - update-nats
  - acquire-nginx-buildpack-pre-dev-lock
  - update-nginx-buildpack
  - acquire-nodejs-buildpack-pre-dev-lock
  - update-nodejs-buildpack
  - acquire-php-buildpack-pre-dev-lock
  - update-php-buildpack
  - acquire-python-buildpack-pre-dev-lock
  - update-python-buildpack
  - acquire-pxc-pre-dev-lock
  - update-pxc
  - acquire-r-buildpack-pre-dev-lock
  - update-r-buildpack
  - acquire-routing-pre-dev-lock
  - update-routing
  - acquire-ruby-buildpack-pre-dev-lock
  - update-ruby-buildpack
  - acquire-silk-pre-dev-lock
  - update-silk
  - acquire-staticfile-buildpack-pre-dev-lock
  - update-staticfile-buildpack
  - acquire-statsd-injector-pre-dev-lock
  - update-statsd-injector
  - acquire-uaa-pre-dev-lock
  - update-uaa
  - acquire-credhub-pre-dev-lock
  - update-credhub
  - acquire-cf-cli-pre-dev-lock
  - update-cf-cli
- name: update-ops-releases
  jobs:
  - acquire-backup-and-restore-sdk-pre-dev-lock
  - update-backup-and-restore-sdk
  - acquire-bits-service-pre-dev-lock
  - update-bits-service
  - acquire-cf-app-sd-pre-dev-lock
  - update-cf-app-sd
  - acquire-haproxy-pre-dev-lock
  - update-haproxy
  - acquire-mapfs-pre-dev-lock
  - update-mapfs
  - acquire-nfs-volume-pre-dev-lock
  - update-nfs-volume
  - acquire-smb-volume-pre-dev-lock
  - update-smb-volume
  - acquire-postgres-pre-dev-lock
  - update-postgres
  - acquire-syslog-pre-dev-lock
  - update-syslog
  - acquire-windows-syslog-pre-dev-lock
  - update-windows-syslog
  - acquire-hwc-buildpack-pre-dev-lock
  - update-hwc-buildpack
  - acquire-windows-utilities-pre-dev-lock
  - update-windows-utilities
  - acquire-garden-windows-pre-dev-lock
  - update-garden-windows
  - acquire-winc-pre-dev-lock
  - update-winc
  - acquire-windows1803fs-pre-dev-lock
  - update-windows1803fs
  - acquire-windows2016fs-pre-dev-lock
  - update-windows2016fs
  - acquire-windowsfs-pre-dev-lock
  - update-windowsfs
  - acquire-node-exporter-pre-dev-lock
  - update-node-exporter
  - acquire-system-metrics-pre-dev-lock
  - update-system-metrics
  - acquire-system-metrics-scraper-pre-dev-lock
  - update-system-metrics-scraper
  - acquire-metric-store-pre-dev-lock
  - update-metric-store
  - acquire-envoy-nginx-pre-dev-lock
  - update-envoy-nginx
  - acquire-metrics-discovery-pre-dev-lock
  - update-metrics-discovery
  - update-datadog-firehose-nozzle
- name: update-windows-stemcells-and-releases
  jobs:
  - update-windows2012R2-stemcell
  - update-windows2016-stemcell
  - update-windows1803-stemcell
  - update-windows2019-stemcell
  - update-windows1803fs-offline-release
  - update-windows2016fs-offline-release
  - update-windows2019fs-offline-release
- name: debug
  jobs: []
- name: cleanup
  jobs:
  - delete-stale-branches
- name: infrastructure
  jobs:
  - setup-infrastructure-compilation
  - destroy-infrastructure-compilation
  - run-bosh-cleanup-compilation
resource_types:
- name: stemcell-version-bump
  type: docker-image
  source:
    repository: relintdockerhubpushbot/stemcell-version-bump-resource
- name: gcs-resource
  type: docker-image
  source:
    repository: frodenas/gcs-resource
- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource
    tag: latest
resources:
- name: cf-deployment-all-branches
  type: git
  icon: github-box
  source:
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: ((cf_deployment_readwrite_deploy_key.private_key))
- name: cf-deployment-develop
  type: git
  icon: github-box
  source:
    branch: develop
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: ((cf_deployment_readwrite_deploy_key.private_key))
- name: cf-deployment-release-candidate
  type: git
  icon: github-box
  source:
    branch: release-candidate
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: ((cf_deployment_readwrite_deploy_key.private_key))
- name: cf-deployment-master
  type: git
  icon: github-box
  source:
    branch: master
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: ((cf_deployment_readwrite_deploy_key.private_key))
- name: cf-deployment-version
  type: semver
  source:
    driver: git
    uri: git@github.com:cloudfoundry/cf-relint-ci-semver.git
    branch: master
    private_key: ((cf_relint_ci_semver_readwrite_deploy_key.private_key))
    git_user: CF MEGA BOT <cf-mega@pivotal.io>
    file: cf-deployment-version
- name: cf-deployment-release
  type: github-release
  source:
    owner: cloudfoundry
    repository: cf-deployment
    access_token: ((cf_deployment_release_bot_access_token))
- name: cf-deployment-concourse-tasks
  type: git
  icon: github-box
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git
- name: relint-envs
  type: git
  icon: github-box
  source:
    branch: master
    uri: git@github.com:cloudfoundry/relint-envs.git
    private_key: ((hagrid_env_readwrite_deploy_key.private_key))
- name: relint-team
  type: git
  icon: github-box
  source:
    branch: master
    uri: git@github.com:cloudfoundry/relint-team.git
    private_key: ((runtime_ci_private_read_deploy_key.private_key))
- name: runtime-ci
  type: git
  icon: github-box
  source:
    branch: master
    uri: https://github.com/cloudfoundry/runtime-ci.git
- name: stemcell
  type: bosh-io-stemcell
  icon: dna
  source:
    name: bosh-google-kvm-ubuntu-xenial-go_agent
- name: stemcell-version-bump-detect
  type: stemcell-version-bump
  icon: dna
  source:
    json_key: ((concourse_gcp_service_account_json))
    bucket_name: cf-deployment-stemcell-bump
    file_name: stemcell-version
- name: stemcell-version-bump-major
  type: stemcell-version-bump
  icon: dna
  source:
    json_key: ((concourse_gcp_service_account_json))
    bucket_name: cf-deployment-stemcell-bump
    file_name: stemcell-version
    type_filter: major
- name: stemcell-version-bump-minor
  type: stemcell-version-bump
  icon: dna
  source:
    json_key: ((concourse_gcp_service_account_json))
    bucket_name: cf-deployment-stemcell-bump
    file_name: stemcell-version
    type_filter: minor
- name: windows1803fs-offline-release
  type: github-release
  icon: github-face
  source:
    owner: cloudfoundry
    repository: windows1803fs-release
    access_token: ((release_integration_download_bot_access_token))
- name: windows2016fs-offline-release
  type: github-release
  icon: github-face
  source:
    owner: cloudfoundry
    repository: windows2016fs-release
    access_token: ((release_integration_download_bot_access_token))
- name: windows2019fs-offline-release
  type: github-release
  icon: github-face
  source:
    owner: cloudfoundry
    repository: windows2019fs-release
    access_token: ((release_integration_download_bot_access_token))
- name: binary-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/binary-buildpack-release
- name: bosh-dns-aliases-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/bosh-dns-aliases-release
- name: bpm-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/bpm-release
- name: capi-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/capi-release
- name: cf-networking-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cf-networking-release
- name: cf-smoke-tests-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cf-smoke-tests-release
- name: cf-syslog-drain-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cf-syslog-drain-release
- name: cflinuxfs3-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cflinuxfs3-release
- name: diego-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/diego-release
- name: dotnet-core-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/dotnet-core-buildpack-release
- name: garden-runc-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/garden-runc-release
- name: go-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/go-buildpack-release
- name: java-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/java-buildpack-release
- name: log-cache-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/log-cache-release
- name: loggregator-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/loggregator-release
- name: loggregator-agent-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/loggregator-agent-release
- name: nats-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/nats-release
- name: nginx-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/nginx-buildpack-release
- name: nodejs-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/nodejs-buildpack-release
- name: php-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/php-buildpack-release
- name: python-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/python-buildpack-release
- name: pxc-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/pxc-release
- name: r-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/r-buildpack-release
- name: routing-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/routing-release
- name: ruby-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/ruby-buildpack-release
- name: silk-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/silk-release
- name: staticfile-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/staticfile-buildpack-release
- name: statsd-injector-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/statsd-injector-release
- name: uaa-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/uaa-release
- name: credhub-release
  type: bosh-io-release
  source:
    repository: pivotal-cf/credhub-release
- name: cf-cli-release
  type: bosh-io-release
  source:
    repository: bosh-packages/cf-cli-release
- name: backup-and-restore-sdk-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/backup-and-restore-sdk-release
- name: bits-service-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/bits-service-release
- name: cf-app-sd-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cf-app-sd-release
- name: haproxy-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/haproxy-boshrelease
- name: mapfs-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/mapfs-release
- name: nfs-volume-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/nfs-volume-release
- name: smb-volume-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/smb-volume-release
- name: postgres-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/postgres-release
- name: syslog-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/syslog-release
- name: windows-syslog-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/windows-syslog-release
- name: hwc-buildpack-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/hwc-buildpack-release
- name: windows-utilities-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/windows-utilities-release
- name: garden-windows-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/garden-windows-bosh-release
- name: winc-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/winc-release
- name: windows1803fs-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/windows1803fs-online-release
- name: windows2016fs-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/windows2016fs-online-release
- name: windowsfs-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/windowsfs-online-release
- name: node-exporter-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-community/node-exporter-boshrelease
- name: system-metrics-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/system-metrics-release
- name: system-metrics-scraper-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/system-metrics-scraper-release
- name: metric-store-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/metric-store-release
- name: envoy-nginx-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/envoy-nginx-release
- name: metrics-discovery-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/metrics-discovery-release
- name: datadog-firehose-nozzle-release
  type: bosh-io-release
  source:
    repository: DataDog/datadog-firehose-nozzle-release
- name: binary-buildpack-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: binary-buildpack-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: binary-buildpack-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: binary-buildpack/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: bosh-dns-aliases-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: bosh-dns-aliases-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: bosh-dns-aliases-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: bosh-dns-aliases/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: bpm-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: bpm-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: bpm-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: bpm/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: capi-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: capi-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: capi-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: capi/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: cf-networking-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: cf-networking-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: cf-networking-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: cf-networking/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: cf-smoke-tests-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: cf-smoke-tests-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: cf-smoke-tests-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: cf-smoke-tests/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: cf-syslog-drain-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: cf-syslog-drain-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: cf-syslog-drain-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: cf-syslog-drain/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: cflinuxfs3-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: cflinuxfs3-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: cflinuxfs3-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: cflinuxfs3/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: diego-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: diego-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: diego-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: diego/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: dotnet-core-buildpack-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: dotnet-core-buildpack-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: dotnet-core-buildpack-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: dotnet-core-buildpack/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: garden-runc-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: garden-runc-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: garden-runc-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: garden-runc/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: go-buildpack-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: go-buildpack-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: go-buildpack-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: go-buildpack/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: java-buildpack-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: java-buildpack-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: java-buildpack-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: java-buildpack/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: log-cache-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: log-cache-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: log-cache-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: log-cache/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: loggregator-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: loggregator-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: loggregator-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: loggregator/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: loggregator-agent-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: loggregator-agent-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: loggregator-agent-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: loggregator-agent/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: nats-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: nats-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: nats-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: nats/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: nginx-buildpack-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: nginx-buildpack-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: nginx-buildpack-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: nginx-buildpack/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: nodejs-buildpack-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: nodejs-buildpack-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: nodejs-buildpack-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: nodejs-buildpack/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: php-buildpack-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: php-buildpack-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: php-buildpack-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: php-buildpack/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: python-buildpack-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: python-buildpack-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: python-buildpack-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: python-buildpack/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: pxc-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: pxc-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: pxc-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: pxc/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: r-buildpack-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: r-buildpack-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: r-buildpack-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: r-buildpack/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: routing-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: routing-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: routing-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: routing/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: ruby-buildpack-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: ruby-buildpack-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: ruby-buildpack-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: ruby-buildpack/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: silk-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: silk-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: silk-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: silk/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: staticfile-buildpack-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: staticfile-buildpack-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: staticfile-buildpack-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: staticfile-buildpack/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: statsd-injector-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: statsd-injector-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: statsd-injector-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: statsd-injector/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: uaa-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: uaa-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: uaa-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: uaa/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: credhub-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: credhub-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: credhub-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: credhub/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: cf-cli-release-gcs
  type: gcs-resource
  source:
    bucket: cf-deployment-compiled-releases
    json_key: ((concourse_gcp_service_account_json))
    regexp: cf-cli-[^-]+-ubuntu-xenial-[^-]+-(\d+)-(\d+)-(\d+).*\.tgz
- name: cf-cli-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: cf-cli/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: backup-and-restore-sdk-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: backup-and-restore-sdk/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: bits-service-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: bits-service/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: cf-app-sd-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: cf-app-sd/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: haproxy-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: haproxy/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: mapfs-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: mapfs/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: nfs-volume-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: nfs-volume/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: smb-volume-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: smb-volume/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: postgres-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: postgres/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: syslog-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: syslog/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: windows-syslog-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: windows-syslog/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: hwc-buildpack-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: hwc-buildpack/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: windows-utilities-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: windows-utilities/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: garden-windows-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: garden-windows/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: winc-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: winc/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: windows1803fs-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: windows1803fs/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: windows2016fs-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: windows2016fs/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: windowsfs-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: windowsfs/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: node-exporter-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: node-exporter/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: system-metrics-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: system-metrics/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: system-metrics-scraper-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: system-metrics-scraper/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: metric-store-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: metric-store/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: envoy-nginx-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: envoy-nginx/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: metrics-discovery-component-bump-logs-gcs
  type: gcs-resource
  source:
    bucket: component-bump-logs
    json_key: ((greengrass_gcp_service_account_json))
    regexp: metrics-discovery/cf-(\d+)-(\d+)-(\d+)\.tgz
- name: windows2012R2-stemcell
  type: bosh-io-stemcell
  icon: dna
  source:
    name: bosh-google-kvm-windows2012R2-go_agent
- name: windows2016-stemcell
  type: bosh-io-stemcell
  icon: dna
  source:
    name: bosh-google-kvm-windows2016-go_agent
- name: windows1803-stemcell
  type: bosh-io-stemcell
  icon: dna
  source:
    name: bosh-google-kvm-windows1803-go_agent
- name: windows2019-stemcell
  type: bosh-io-stemcell
  icon: dna
  source:
    name: bosh-google-kvm-windows2019-go_agent
- name: slack-alert
  type: slack-notification
  icon: slack
  source:
    url: ((relint_slack_incoming_webhook))
- name: daily
  type: time
  icon: clock-outline
  source:
    start: 3:00 -0700
    stop: 3:30 -0700
    interval: 24h
- name: pre-dev-pool
  type: pool
  icon: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: update-release-pool
    private_key: ((relint_ci_pools_readwrite_deploy_key.private_key))
- name: pre-dev-dagobah
  type: pool
  icon: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: update-release-pool
    private_key: ((relint_ci_pools_readwrite_deploy_key.private_key))
- name: pre-dev-endor
  type: pool
  icon: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: update-release-pool
    private_key: ((relint_ci_pools_readwrite_deploy_key.private_key))
- name: pre-dev-hoth
  type: pool
  icon: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: update-release-pool
    private_key: ((relint_ci_pools_readwrite_deploy_key.private_key))
- name: pre-dev-tatooine
  type: pool
  icon: pool
  source:
    uri: git@github.com:cloudfoundry/relint-ci-pools
    branch: master
    pool: update-release-pool
    private_key: ((relint_ci_pools_readwrite_deploy_key.private_key))
jobs:
- name: acquire-binary-buildpack-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: binary-buildpack-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-binary-buildpack
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-binary-buildpack-pre-dev-lock
      trigger: true
    - get: binary-buildpack-release
      params:
        tarball: false
      passed:
      - acquire-binary-buildpack-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-binary-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: binary-buildpack-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-binary-buildpack-release-candidate
    params:
      RELEASE_NAME: binary-buildpack
  - task: update-additional-ops-files-binary-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-binary-buildpack-release-candidate
      release: binary-buildpack-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-binary-buildpack-release-candidate
    params:
      RELEASE_NAME: binary-buildpack
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-binary-buildpack-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-binary-buildpack-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-binary-buildpack-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-binary-buildpack-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-binary-buildpack
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-binary-buildpack-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: binary-buildpack
      on_success:
        do:
        - task: update-release-binary-buildpack-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: binary-buildpack-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-binary-buildpack-develop
          params:
            RELEASE_NAME: binary-buildpack
        - task: update-additional-ops-files-binary-buildpack-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-binary-buildpack-develop
            release: binary-buildpack-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-binary-buildpack-develop
          params:
            RELEASE_NAME: binary-buildpack
        - task: update-compiled-releases-ops-file-binary-buildpack-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-binary-buildpack-develop
            release: binary-buildpack-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-binary-buildpack-develop
          params:
            RELEASE_NAME: binary-buildpack
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: binary-buildpack-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-binary-buildpack-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-binary-buildpack-release-candidate
            release: binary-buildpack-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: binary-buildpack
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: binary-buildpack-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: binary-buildpack-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/binary-buildpack
              RELEASE_NAME: binary-buildpack
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/binary-buildpack-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-bosh-dns-aliases-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: bosh-dns-aliases-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-bosh-dns-aliases
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-bosh-dns-aliases-pre-dev-lock
      trigger: true
    - get: bosh-dns-aliases-release
      params:
        tarball: false
      passed:
      - acquire-bosh-dns-aliases-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-bosh-dns-aliases-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: bosh-dns-aliases-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-bosh-dns-aliases-release-candidate
    params:
      RELEASE_NAME: bosh-dns-aliases
  - task: update-additional-ops-files-bosh-dns-aliases-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-bosh-dns-aliases-release-candidate
      release: bosh-dns-aliases-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-bosh-dns-aliases-release-candidate
    params:
      RELEASE_NAME: bosh-dns-aliases
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-bosh-dns-aliases-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-bosh-dns-aliases-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-bosh-dns-aliases-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-bosh-dns-aliases-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-bosh-dns-aliases
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-bosh-dns-aliases-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: bosh-dns-aliases
      on_success:
        do:
        - task: update-release-bosh-dns-aliases-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: bosh-dns-aliases-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-bosh-dns-aliases-develop
          params:
            RELEASE_NAME: bosh-dns-aliases
        - task: update-additional-ops-files-bosh-dns-aliases-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-bosh-dns-aliases-develop
            release: bosh-dns-aliases-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-bosh-dns-aliases-develop
          params:
            RELEASE_NAME: bosh-dns-aliases
        - task: update-compiled-releases-ops-file-bosh-dns-aliases-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-bosh-dns-aliases-develop
            release: bosh-dns-aliases-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-bosh-dns-aliases-develop
          params:
            RELEASE_NAME: bosh-dns-aliases
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: bosh-dns-aliases-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-bosh-dns-aliases-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-bosh-dns-aliases-release-candidate
            release: bosh-dns-aliases-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: bosh-dns-aliases
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: bosh-dns-aliases-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: bosh-dns-aliases-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/bosh-dns-aliases
              RELEASE_NAME: bosh-dns-aliases
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/bosh-dns-aliases-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-bpm-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: bpm-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-bpm
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-bpm-pre-dev-lock
      trigger: true
    - get: bpm-release
      params:
        tarball: false
      passed:
      - acquire-bpm-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-bpm-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: bpm-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-bpm-release-candidate
    params:
      RELEASE_NAME: bpm
  - task: update-additional-ops-files-bpm-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-bpm-release-candidate
      release: bpm-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-bpm-release-candidate
    params:
      RELEASE_NAME: bpm
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-bpm-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-bpm-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-bpm-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-bpm-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-bpm
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-bpm-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: bpm
      on_success:
        do:
        - task: update-release-bpm-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: bpm-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-bpm-develop
          params:
            RELEASE_NAME: bpm
        - task: update-additional-ops-files-bpm-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-bpm-develop
            release: bpm-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-bpm-develop
          params:
            RELEASE_NAME: bpm
        - task: update-compiled-releases-ops-file-bpm-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-bpm-develop
            release: bpm-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-bpm-develop
          params:
            RELEASE_NAME: bpm
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: bpm-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-bpm-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-bpm-release-candidate
            release: bpm-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: bpm
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: bpm-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: bpm-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/bpm
              RELEASE_NAME: bpm
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/bpm-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-capi-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: capi-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-capi
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-capi-pre-dev-lock
      trigger: true
    - get: capi-release
      params:
        tarball: false
      passed:
      - acquire-capi-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-capi-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: capi-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-capi-release-candidate
    params:
      RELEASE_NAME: capi
  - task: update-additional-ops-files-capi-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-capi-release-candidate
      release: capi-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-capi-release-candidate
    params:
      RELEASE_NAME: capi
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-capi-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-capi-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-capi-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-capi-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-capi
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-capi-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: capi
      on_success:
        do:
        - task: update-release-capi-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: capi-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-capi-develop
          params:
            RELEASE_NAME: capi
        - task: update-additional-ops-files-capi-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-capi-develop
            release: capi-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-capi-develop
          params:
            RELEASE_NAME: capi
        - task: update-compiled-releases-ops-file-capi-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-capi-develop
            release: capi-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-capi-develop
          params:
            RELEASE_NAME: capi
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: capi-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-capi-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-capi-release-candidate
            release: capi-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: capi
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: capi-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: capi-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/capi
              RELEASE_NAME: capi
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/capi-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-cf-networking-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: cf-networking-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-cf-networking
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-cf-networking-pre-dev-lock
      trigger: true
    - get: cf-networking-release
      params:
        tarball: false
      passed:
      - acquire-cf-networking-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-cf-networking-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: cf-networking-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-cf-networking-release-candidate
    params:
      RELEASE_NAME: cf-networking
  - task: update-additional-ops-files-cf-networking-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-cf-networking-release-candidate
      release: cf-networking-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-cf-networking-release-candidate
    params:
      RELEASE_NAME: cf-networking
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-cf-networking-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-cf-networking-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-cf-networking-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-cf-networking-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-cf-networking
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-cf-networking-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: cf-networking
      on_success:
        do:
        - task: update-release-cf-networking-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: cf-networking-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-cf-networking-develop
          params:
            RELEASE_NAME: cf-networking
        - task: update-additional-ops-files-cf-networking-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-cf-networking-develop
            release: cf-networking-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-cf-networking-develop
          params:
            RELEASE_NAME: cf-networking
        - task: update-compiled-releases-ops-file-cf-networking-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-cf-networking-develop
            release: cf-networking-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-cf-networking-develop
          params:
            RELEASE_NAME: cf-networking
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: cf-networking-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-cf-networking-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-cf-networking-release-candidate
            release: cf-networking-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: cf-networking
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: cf-networking-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: cf-networking-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/cf-networking
              RELEASE_NAME: cf-networking
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/cf-networking-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-cf-smoke-tests-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: cf-smoke-tests-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-cf-smoke-tests
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-cf-smoke-tests-pre-dev-lock
      trigger: true
    - get: cf-smoke-tests-release
      params:
        tarball: false
      passed:
      - acquire-cf-smoke-tests-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-cf-smoke-tests-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: cf-smoke-tests-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-cf-smoke-tests-release-candidate
    params:
      RELEASE_NAME: cf-smoke-tests
  - task: update-additional-ops-files-cf-smoke-tests-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-cf-smoke-tests-release-candidate
      release: cf-smoke-tests-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-cf-smoke-tests-release-candidate
    params:
      RELEASE_NAME: cf-smoke-tests
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-cf-smoke-tests-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-cf-smoke-tests-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-cf-smoke-tests-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-cf-smoke-tests-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-cf-smoke-tests
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-cf-smoke-tests-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: cf-smoke-tests
      on_success:
        do:
        - task: update-release-cf-smoke-tests-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: cf-smoke-tests-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-cf-smoke-tests-develop
          params:
            RELEASE_NAME: cf-smoke-tests
        - task: update-additional-ops-files-cf-smoke-tests-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-cf-smoke-tests-develop
            release: cf-smoke-tests-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-cf-smoke-tests-develop
          params:
            RELEASE_NAME: cf-smoke-tests
        - task: update-compiled-releases-ops-file-cf-smoke-tests-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-cf-smoke-tests-develop
            release: cf-smoke-tests-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-cf-smoke-tests-develop
          params:
            RELEASE_NAME: cf-smoke-tests
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: cf-smoke-tests-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-cf-smoke-tests-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-cf-smoke-tests-release-candidate
            release: cf-smoke-tests-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: cf-smoke-tests
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: cf-smoke-tests-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: cf-smoke-tests-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/cf-smoke-tests
              RELEASE_NAME: cf-smoke-tests
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/cf-smoke-tests-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-cf-syslog-drain-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: cf-syslog-drain-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-cf-syslog-drain
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-cf-syslog-drain-pre-dev-lock
      trigger: true
    - get: cf-syslog-drain-release
      params:
        tarball: false
      passed:
      - acquire-cf-syslog-drain-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-cf-syslog-drain-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: cf-syslog-drain-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-cf-syslog-drain-release-candidate
    params:
      RELEASE_NAME: cf-syslog-drain
  - task: update-additional-ops-files-cf-syslog-drain-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-cf-syslog-drain-release-candidate
      release: cf-syslog-drain-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-cf-syslog-drain-release-candidate
    params:
      RELEASE_NAME: cf-syslog-drain
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-cf-syslog-drain-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-cf-syslog-drain-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-cf-syslog-drain-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-cf-syslog-drain-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-cf-syslog-drain
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-cf-syslog-drain-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: cf-syslog-drain
      on_success:
        do:
        - task: update-release-cf-syslog-drain-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: cf-syslog-drain-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-cf-syslog-drain-develop
          params:
            RELEASE_NAME: cf-syslog-drain
        - task: update-additional-ops-files-cf-syslog-drain-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-cf-syslog-drain-develop
            release: cf-syslog-drain-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-cf-syslog-drain-develop
          params:
            RELEASE_NAME: cf-syslog-drain
        - task: update-compiled-releases-ops-file-cf-syslog-drain-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-cf-syslog-drain-develop
            release: cf-syslog-drain-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-cf-syslog-drain-develop
          params:
            RELEASE_NAME: cf-syslog-drain
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: cf-syslog-drain-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-cf-syslog-drain-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-cf-syslog-drain-release-candidate
            release: cf-syslog-drain-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: cf-syslog-drain
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: cf-syslog-drain-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: cf-syslog-drain-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/cf-syslog-drain
              RELEASE_NAME: cf-syslog-drain
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/cf-syslog-drain-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-cflinuxfs3-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: cflinuxfs3-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-cflinuxfs3
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-cflinuxfs3-pre-dev-lock
      trigger: true
    - get: cflinuxfs3-release
      params:
        tarball: false
      passed:
      - acquire-cflinuxfs3-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-cflinuxfs3-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: cflinuxfs3-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-cflinuxfs3-release-candidate
    params:
      RELEASE_NAME: cflinuxfs3
  - task: update-additional-ops-files-cflinuxfs3-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-cflinuxfs3-release-candidate
      release: cflinuxfs3-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-cflinuxfs3-release-candidate
    params:
      RELEASE_NAME: cflinuxfs3
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-cflinuxfs3-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-cflinuxfs3-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-cflinuxfs3-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-cflinuxfs3-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-cflinuxfs3
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-cflinuxfs3-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: cflinuxfs3
      on_success:
        do:
        - task: update-release-cflinuxfs3-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: cflinuxfs3-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-cflinuxfs3-develop
          params:
            RELEASE_NAME: cflinuxfs3
        - task: update-additional-ops-files-cflinuxfs3-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-cflinuxfs3-develop
            release: cflinuxfs3-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-cflinuxfs3-develop
          params:
            RELEASE_NAME: cflinuxfs3
        - task: update-compiled-releases-ops-file-cflinuxfs3-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-cflinuxfs3-develop
            release: cflinuxfs3-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-cflinuxfs3-develop
          params:
            RELEASE_NAME: cflinuxfs3
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: cflinuxfs3-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-cflinuxfs3-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-cflinuxfs3-release-candidate
            release: cflinuxfs3-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: cflinuxfs3
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: cflinuxfs3-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: cflinuxfs3-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/cflinuxfs3
              RELEASE_NAME: cflinuxfs3
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/cflinuxfs3-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-diego-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: diego-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-diego
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-diego-pre-dev-lock
      trigger: true
    - get: diego-release
      params:
        tarball: false
      passed:
      - acquire-diego-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-diego-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: diego-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-diego-release-candidate
    params:
      RELEASE_NAME: diego
  - task: update-additional-ops-files-diego-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-diego-release-candidate
      release: diego-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-diego-release-candidate
    params:
      RELEASE_NAME: diego
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-diego-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-diego-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-diego-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-diego-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-diego
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-diego-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: diego
      on_success:
        do:
        - task: update-release-diego-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: diego-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-diego-develop
          params:
            RELEASE_NAME: diego
        - task: update-additional-ops-files-diego-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-diego-develop
            release: diego-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-diego-develop
          params:
            RELEASE_NAME: diego
        - task: update-compiled-releases-ops-file-diego-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-diego-develop
            release: diego-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-diego-develop
          params:
            RELEASE_NAME: diego
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: diego-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-diego-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-diego-release-candidate
            release: diego-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: diego
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: diego-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: diego-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/diego
              RELEASE_NAME: diego
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/diego-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-dotnet-core-buildpack-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: dotnet-core-buildpack-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-dotnet-core-buildpack
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-dotnet-core-buildpack-pre-dev-lock
      trigger: true
    - get: dotnet-core-buildpack-release
      params:
        tarball: false
      passed:
      - acquire-dotnet-core-buildpack-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-dotnet-core-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: dotnet-core-buildpack-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-dotnet-core-buildpack-release-candidate
    params:
      RELEASE_NAME: dotnet-core-buildpack
  - task: update-additional-ops-files-dotnet-core-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-dotnet-core-buildpack-release-candidate
      release: dotnet-core-buildpack-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-dotnet-core-buildpack-release-candidate
    params:
      RELEASE_NAME: dotnet-core-buildpack
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-dotnet-core-buildpack-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-dotnet-core-buildpack-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-dotnet-core-buildpack-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-dotnet-core-buildpack-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-dotnet-core-buildpack
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-dotnet-core-buildpack-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: dotnet-core-buildpack
      on_success:
        do:
        - task: update-release-dotnet-core-buildpack-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: dotnet-core-buildpack-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-dotnet-core-buildpack-develop
          params:
            RELEASE_NAME: dotnet-core-buildpack
        - task: update-additional-ops-files-dotnet-core-buildpack-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-dotnet-core-buildpack-develop
            release: dotnet-core-buildpack-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-dotnet-core-buildpack-develop
          params:
            RELEASE_NAME: dotnet-core-buildpack
        - task: update-compiled-releases-ops-file-dotnet-core-buildpack-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-dotnet-core-buildpack-develop
            release: dotnet-core-buildpack-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-dotnet-core-buildpack-develop
          params:
            RELEASE_NAME: dotnet-core-buildpack
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: dotnet-core-buildpack-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-dotnet-core-buildpack-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-dotnet-core-buildpack-release-candidate
            release: dotnet-core-buildpack-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: dotnet-core-buildpack
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: dotnet-core-buildpack-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: dotnet-core-buildpack-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/dotnet-core-buildpack
              RELEASE_NAME: dotnet-core-buildpack
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/dotnet-core-buildpack-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-garden-runc-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: garden-runc-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-garden-runc
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-garden-runc-pre-dev-lock
      trigger: true
    - get: garden-runc-release
      params:
        tarball: false
      passed:
      - acquire-garden-runc-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-garden-runc-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: garden-runc-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-garden-runc-release-candidate
    params:
      RELEASE_NAME: garden-runc
  - task: update-additional-ops-files-garden-runc-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-garden-runc-release-candidate
      release: garden-runc-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-garden-runc-release-candidate
    params:
      RELEASE_NAME: garden-runc
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-garden-runc-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-garden-runc-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-garden-runc-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-garden-runc-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-garden-runc
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-garden-runc-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: garden-runc
      on_success:
        do:
        - task: update-release-garden-runc-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: garden-runc-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-garden-runc-develop
          params:
            RELEASE_NAME: garden-runc
        - task: update-additional-ops-files-garden-runc-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-garden-runc-develop
            release: garden-runc-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-garden-runc-develop
          params:
            RELEASE_NAME: garden-runc
        - task: update-compiled-releases-ops-file-garden-runc-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-garden-runc-develop
            release: garden-runc-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-garden-runc-develop
          params:
            RELEASE_NAME: garden-runc
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: garden-runc-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-garden-runc-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-garden-runc-release-candidate
            release: garden-runc-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: garden-runc
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: garden-runc-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: garden-runc-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/garden-runc
              RELEASE_NAME: garden-runc
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/garden-runc-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-go-buildpack-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: go-buildpack-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-go-buildpack
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-go-buildpack-pre-dev-lock
      trigger: true
    - get: go-buildpack-release
      params:
        tarball: false
      passed:
      - acquire-go-buildpack-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-go-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: go-buildpack-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-go-buildpack-release-candidate
    params:
      RELEASE_NAME: go-buildpack
  - task: update-additional-ops-files-go-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-go-buildpack-release-candidate
      release: go-buildpack-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-go-buildpack-release-candidate
    params:
      RELEASE_NAME: go-buildpack
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-go-buildpack-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-go-buildpack-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-go-buildpack-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-go-buildpack-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-go-buildpack
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-go-buildpack-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: go-buildpack
      on_success:
        do:
        - task: update-release-go-buildpack-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: go-buildpack-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-go-buildpack-develop
          params:
            RELEASE_NAME: go-buildpack
        - task: update-additional-ops-files-go-buildpack-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-go-buildpack-develop
            release: go-buildpack-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-go-buildpack-develop
          params:
            RELEASE_NAME: go-buildpack
        - task: update-compiled-releases-ops-file-go-buildpack-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-go-buildpack-develop
            release: go-buildpack-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-go-buildpack-develop
          params:
            RELEASE_NAME: go-buildpack
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: go-buildpack-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-go-buildpack-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-go-buildpack-release-candidate
            release: go-buildpack-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: go-buildpack
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: go-buildpack-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: go-buildpack-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/go-buildpack
              RELEASE_NAME: go-buildpack
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/go-buildpack-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-java-buildpack-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: java-buildpack-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-java-buildpack
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-java-buildpack-pre-dev-lock
      trigger: true
    - get: java-buildpack-release
      params:
        tarball: false
      passed:
      - acquire-java-buildpack-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-java-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: java-buildpack-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-java-buildpack-release-candidate
    params:
      RELEASE_NAME: java-buildpack
  - task: update-additional-ops-files-java-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-java-buildpack-release-candidate
      release: java-buildpack-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-java-buildpack-release-candidate
    params:
      RELEASE_NAME: java-buildpack
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-java-buildpack-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-java-buildpack-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-java-buildpack-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-java-buildpack-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-java-buildpack
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-java-buildpack-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: java-buildpack
      on_success:
        do:
        - task: update-release-java-buildpack-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: java-buildpack-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-java-buildpack-develop
          params:
            RELEASE_NAME: java-buildpack
        - task: update-additional-ops-files-java-buildpack-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-java-buildpack-develop
            release: java-buildpack-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-java-buildpack-develop
          params:
            RELEASE_NAME: java-buildpack
        - task: update-compiled-releases-ops-file-java-buildpack-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-java-buildpack-develop
            release: java-buildpack-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-java-buildpack-develop
          params:
            RELEASE_NAME: java-buildpack
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: java-buildpack-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-java-buildpack-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-java-buildpack-release-candidate
            release: java-buildpack-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: java-buildpack
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: java-buildpack-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: java-buildpack-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/java-buildpack
              RELEASE_NAME: java-buildpack
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/java-buildpack-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-log-cache-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: log-cache-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-log-cache
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-log-cache-pre-dev-lock
      trigger: true
    - get: log-cache-release
      params:
        tarball: false
      passed:
      - acquire-log-cache-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-log-cache-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: log-cache-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-log-cache-release-candidate
    params:
      RELEASE_NAME: log-cache
  - task: update-additional-ops-files-log-cache-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-log-cache-release-candidate
      release: log-cache-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-log-cache-release-candidate
    params:
      RELEASE_NAME: log-cache
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-log-cache-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-log-cache-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-log-cache-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-log-cache-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-log-cache
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-log-cache-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: log-cache
      on_success:
        do:
        - task: update-release-log-cache-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: log-cache-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-log-cache-develop
          params:
            RELEASE_NAME: log-cache
        - task: update-additional-ops-files-log-cache-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-log-cache-develop
            release: log-cache-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-log-cache-develop
          params:
            RELEASE_NAME: log-cache
        - task: update-compiled-releases-ops-file-log-cache-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-log-cache-develop
            release: log-cache-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-log-cache-develop
          params:
            RELEASE_NAME: log-cache
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: log-cache-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-log-cache-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-log-cache-release-candidate
            release: log-cache-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: log-cache
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: log-cache-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: log-cache-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/log-cache
              RELEASE_NAME: log-cache
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/log-cache-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-loggregator-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: loggregator-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-loggregator
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-loggregator-pre-dev-lock
      trigger: true
    - get: loggregator-release
      params:
        tarball: false
      passed:
      - acquire-loggregator-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-loggregator-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: loggregator-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-loggregator-release-candidate
    params:
      RELEASE_NAME: loggregator
  - task: update-additional-ops-files-loggregator-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-loggregator-release-candidate
      release: loggregator-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-loggregator-release-candidate
    params:
      RELEASE_NAME: loggregator
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-loggregator-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-loggregator-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-loggregator-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-loggregator-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-loggregator
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-loggregator-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: loggregator
      on_success:
        do:
        - task: update-release-loggregator-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: loggregator-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-loggregator-develop
          params:
            RELEASE_NAME: loggregator
        - task: update-additional-ops-files-loggregator-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-loggregator-develop
            release: loggregator-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-loggregator-develop
          params:
            RELEASE_NAME: loggregator
        - task: update-compiled-releases-ops-file-loggregator-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-loggregator-develop
            release: loggregator-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-loggregator-develop
          params:
            RELEASE_NAME: loggregator
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: loggregator-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-loggregator-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-loggregator-release-candidate
            release: loggregator-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: loggregator
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: loggregator-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: loggregator-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/loggregator
              RELEASE_NAME: loggregator
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/loggregator-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-loggregator-agent-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: loggregator-agent-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-loggregator-agent
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-loggregator-agent-pre-dev-lock
      trigger: true
    - get: loggregator-agent-release
      params:
        tarball: false
      passed:
      - acquire-loggregator-agent-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-loggregator-agent-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: loggregator-agent-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-loggregator-agent-release-candidate
    params:
      RELEASE_NAME: loggregator-agent
  - task: update-additional-ops-files-loggregator-agent-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-loggregator-agent-release-candidate
      release: loggregator-agent-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-loggregator-agent-release-candidate
    params:
      RELEASE_NAME: loggregator-agent
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-loggregator-agent-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-loggregator-agent-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-loggregator-agent-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-loggregator-agent-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-loggregator-agent
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-loggregator-agent-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: loggregator-agent
      on_success:
        do:
        - task: update-release-loggregator-agent-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: loggregator-agent-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-loggregator-agent-develop
          params:
            RELEASE_NAME: loggregator-agent
        - task: update-additional-ops-files-loggregator-agent-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-loggregator-agent-develop
            release: loggregator-agent-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-loggregator-agent-develop
          params:
            RELEASE_NAME: loggregator-agent
        - task: update-compiled-releases-ops-file-loggregator-agent-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-loggregator-agent-develop
            release: loggregator-agent-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-loggregator-agent-develop
          params:
            RELEASE_NAME: loggregator-agent
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: loggregator-agent-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-loggregator-agent-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-loggregator-agent-release-candidate
            release: loggregator-agent-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: loggregator-agent
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: loggregator-agent-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: loggregator-agent-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/loggregator-agent
              RELEASE_NAME: loggregator-agent
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/loggregator-agent-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-nats-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: nats-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-nats
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-nats-pre-dev-lock
      trigger: true
    - get: nats-release
      params:
        tarball: false
      passed:
      - acquire-nats-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-nats-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: nats-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-nats-release-candidate
    params:
      RELEASE_NAME: nats
  - task: update-additional-ops-files-nats-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-nats-release-candidate
      release: nats-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-nats-release-candidate
    params:
      RELEASE_NAME: nats
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-nats-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-nats-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-nats-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-nats-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-nats
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-nats-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: nats
      on_success:
        do:
        - task: update-release-nats-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: nats-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-nats-develop
          params:
            RELEASE_NAME: nats
        - task: update-additional-ops-files-nats-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-nats-develop
            release: nats-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-nats-develop
          params:
            RELEASE_NAME: nats
        - task: update-compiled-releases-ops-file-nats-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-nats-develop
            release: nats-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-nats-develop
          params:
            RELEASE_NAME: nats
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: nats-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-nats-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-nats-release-candidate
            release: nats-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: nats
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: nats-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: nats-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/nats
              RELEASE_NAME: nats
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/nats-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-nginx-buildpack-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: nginx-buildpack-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-nginx-buildpack
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-nginx-buildpack-pre-dev-lock
      trigger: true
    - get: nginx-buildpack-release
      params:
        tarball: false
      passed:
      - acquire-nginx-buildpack-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-nginx-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: nginx-buildpack-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-nginx-buildpack-release-candidate
    params:
      RELEASE_NAME: nginx-buildpack
  - task: update-additional-ops-files-nginx-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-nginx-buildpack-release-candidate
      release: nginx-buildpack-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-nginx-buildpack-release-candidate
    params:
      RELEASE_NAME: nginx-buildpack
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-nginx-buildpack-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-nginx-buildpack-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-nginx-buildpack-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-nginx-buildpack-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-nginx-buildpack
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-nginx-buildpack-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: nginx-buildpack
      on_success:
        do:
        - task: update-release-nginx-buildpack-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: nginx-buildpack-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-nginx-buildpack-develop
          params:
            RELEASE_NAME: nginx-buildpack
        - task: update-additional-ops-files-nginx-buildpack-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-nginx-buildpack-develop
            release: nginx-buildpack-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-nginx-buildpack-develop
          params:
            RELEASE_NAME: nginx-buildpack
        - task: update-compiled-releases-ops-file-nginx-buildpack-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-nginx-buildpack-develop
            release: nginx-buildpack-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-nginx-buildpack-develop
          params:
            RELEASE_NAME: nginx-buildpack
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: nginx-buildpack-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-nginx-buildpack-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-nginx-buildpack-release-candidate
            release: nginx-buildpack-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: nginx-buildpack
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: nginx-buildpack-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: nginx-buildpack-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/nginx-buildpack
              RELEASE_NAME: nginx-buildpack
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/nginx-buildpack-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-nodejs-buildpack-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: nodejs-buildpack-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-nodejs-buildpack
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-nodejs-buildpack-pre-dev-lock
      trigger: true
    - get: nodejs-buildpack-release
      params:
        tarball: false
      passed:
      - acquire-nodejs-buildpack-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-nodejs-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: nodejs-buildpack-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-nodejs-buildpack-release-candidate
    params:
      RELEASE_NAME: nodejs-buildpack
  - task: update-additional-ops-files-nodejs-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-nodejs-buildpack-release-candidate
      release: nodejs-buildpack-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-nodejs-buildpack-release-candidate
    params:
      RELEASE_NAME: nodejs-buildpack
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-nodejs-buildpack-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-nodejs-buildpack-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-nodejs-buildpack-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-nodejs-buildpack-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-nodejs-buildpack
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-nodejs-buildpack-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: nodejs-buildpack
      on_success:
        do:
        - task: update-release-nodejs-buildpack-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: nodejs-buildpack-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-nodejs-buildpack-develop
          params:
            RELEASE_NAME: nodejs-buildpack
        - task: update-additional-ops-files-nodejs-buildpack-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-nodejs-buildpack-develop
            release: nodejs-buildpack-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-nodejs-buildpack-develop
          params:
            RELEASE_NAME: nodejs-buildpack
        - task: update-compiled-releases-ops-file-nodejs-buildpack-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-nodejs-buildpack-develop
            release: nodejs-buildpack-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-nodejs-buildpack-develop
          params:
            RELEASE_NAME: nodejs-buildpack
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: nodejs-buildpack-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-nodejs-buildpack-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-nodejs-buildpack-release-candidate
            release: nodejs-buildpack-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: nodejs-buildpack
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: nodejs-buildpack-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: nodejs-buildpack-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/nodejs-buildpack
              RELEASE_NAME: nodejs-buildpack
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/nodejs-buildpack-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-php-buildpack-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: php-buildpack-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-php-buildpack
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-php-buildpack-pre-dev-lock
      trigger: true
    - get: php-buildpack-release
      params:
        tarball: false
      passed:
      - acquire-php-buildpack-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-php-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: php-buildpack-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-php-buildpack-release-candidate
    params:
      RELEASE_NAME: php-buildpack
  - task: update-additional-ops-files-php-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-php-buildpack-release-candidate
      release: php-buildpack-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-php-buildpack-release-candidate
    params:
      RELEASE_NAME: php-buildpack
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-php-buildpack-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-php-buildpack-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-php-buildpack-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-php-buildpack-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-php-buildpack
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-php-buildpack-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: php-buildpack
      on_success:
        do:
        - task: update-release-php-buildpack-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: php-buildpack-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-php-buildpack-develop
          params:
            RELEASE_NAME: php-buildpack
        - task: update-additional-ops-files-php-buildpack-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-php-buildpack-develop
            release: php-buildpack-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-php-buildpack-develop
          params:
            RELEASE_NAME: php-buildpack
        - task: update-compiled-releases-ops-file-php-buildpack-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-php-buildpack-develop
            release: php-buildpack-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-php-buildpack-develop
          params:
            RELEASE_NAME: php-buildpack
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: php-buildpack-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-php-buildpack-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-php-buildpack-release-candidate
            release: php-buildpack-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: php-buildpack
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: php-buildpack-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: php-buildpack-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/php-buildpack
              RELEASE_NAME: php-buildpack
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/php-buildpack-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-python-buildpack-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: python-buildpack-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-python-buildpack
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-python-buildpack-pre-dev-lock
      trigger: true
    - get: python-buildpack-release
      params:
        tarball: false
      passed:
      - acquire-python-buildpack-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-python-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: python-buildpack-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-python-buildpack-release-candidate
    params:
      RELEASE_NAME: python-buildpack
  - task: update-additional-ops-files-python-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-python-buildpack-release-candidate
      release: python-buildpack-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-python-buildpack-release-candidate
    params:
      RELEASE_NAME: python-buildpack
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-python-buildpack-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-python-buildpack-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-python-buildpack-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-python-buildpack-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-python-buildpack
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-python-buildpack-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: python-buildpack
      on_success:
        do:
        - task: update-release-python-buildpack-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: python-buildpack-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-python-buildpack-develop
          params:
            RELEASE_NAME: python-buildpack
        - task: update-additional-ops-files-python-buildpack-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-python-buildpack-develop
            release: python-buildpack-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-python-buildpack-develop
          params:
            RELEASE_NAME: python-buildpack
        - task: update-compiled-releases-ops-file-python-buildpack-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-python-buildpack-develop
            release: python-buildpack-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-python-buildpack-develop
          params:
            RELEASE_NAME: python-buildpack
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: python-buildpack-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-python-buildpack-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-python-buildpack-release-candidate
            release: python-buildpack-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: python-buildpack
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: python-buildpack-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: python-buildpack-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/python-buildpack
              RELEASE_NAME: python-buildpack
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/python-buildpack-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-pxc-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: pxc-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-pxc
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-pxc-pre-dev-lock
      trigger: true
    - get: pxc-release
      params:
        tarball: false
      passed:
      - acquire-pxc-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-pxc-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: pxc-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-pxc-release-candidate
    params:
      RELEASE_NAME: pxc
  - task: update-additional-ops-files-pxc-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-pxc-release-candidate
      release: pxc-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-pxc-release-candidate
    params:
      RELEASE_NAME: pxc
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-pxc-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-pxc-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-pxc-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-pxc-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-pxc
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-pxc-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: pxc
      on_success:
        do:
        - task: update-release-pxc-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: pxc-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-pxc-develop
          params:
            RELEASE_NAME: pxc
        - task: update-additional-ops-files-pxc-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-pxc-develop
            release: pxc-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-pxc-develop
          params:
            RELEASE_NAME: pxc
        - task: update-compiled-releases-ops-file-pxc-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-pxc-develop
            release: pxc-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-pxc-develop
          params:
            RELEASE_NAME: pxc
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: pxc-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-pxc-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-pxc-release-candidate
            release: pxc-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: pxc
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: pxc-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: pxc-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/pxc
              RELEASE_NAME: pxc
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry-incubator/pxc-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-r-buildpack-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: r-buildpack-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-r-buildpack
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-r-buildpack-pre-dev-lock
      trigger: true
    - get: r-buildpack-release
      params:
        tarball: false
      passed:
      - acquire-r-buildpack-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-r-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: r-buildpack-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-r-buildpack-release-candidate
    params:
      RELEASE_NAME: r-buildpack
  - task: update-additional-ops-files-r-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-r-buildpack-release-candidate
      release: r-buildpack-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-r-buildpack-release-candidate
    params:
      RELEASE_NAME: r-buildpack
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-r-buildpack-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-r-buildpack-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-r-buildpack-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-r-buildpack-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-r-buildpack
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-r-buildpack-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: r-buildpack
      on_success:
        do:
        - task: update-release-r-buildpack-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: r-buildpack-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-r-buildpack-develop
          params:
            RELEASE_NAME: r-buildpack
        - task: update-additional-ops-files-r-buildpack-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-r-buildpack-develop
            release: r-buildpack-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-r-buildpack-develop
          params:
            RELEASE_NAME: r-buildpack
        - task: update-compiled-releases-ops-file-r-buildpack-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-r-buildpack-develop
            release: r-buildpack-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-r-buildpack-develop
          params:
            RELEASE_NAME: r-buildpack
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: r-buildpack-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-r-buildpack-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-r-buildpack-release-candidate
            release: r-buildpack-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: r-buildpack
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: r-buildpack-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: r-buildpack-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/r-buildpack
              RELEASE_NAME: r-buildpack
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/r-buildpack-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-routing-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: routing-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-routing
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-routing-pre-dev-lock
      trigger: true
    - get: routing-release
      params:
        tarball: false
      passed:
      - acquire-routing-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-routing-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: routing-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-routing-release-candidate
    params:
      RELEASE_NAME: routing
  - task: update-additional-ops-files-routing-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-routing-release-candidate
      release: routing-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-routing-release-candidate
    params:
      RELEASE_NAME: routing
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-routing-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-routing-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-routing-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-routing-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-routing
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-routing-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: routing
      on_success:
        do:
        - task: update-release-routing-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: routing-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-routing-develop
          params:
            RELEASE_NAME: routing
        - task: update-additional-ops-files-routing-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-routing-develop
            release: routing-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-routing-develop
          params:
            RELEASE_NAME: routing
        - task: update-compiled-releases-ops-file-routing-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-routing-develop
            release: routing-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-routing-develop
          params:
            RELEASE_NAME: routing
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: routing-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-routing-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-routing-release-candidate
            release: routing-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: routing
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: routing-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: routing-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/routing
              RELEASE_NAME: routing
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/routing-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-ruby-buildpack-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: ruby-buildpack-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-ruby-buildpack
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-ruby-buildpack-pre-dev-lock
      trigger: true
    - get: ruby-buildpack-release
      params:
        tarball: false
      passed:
      - acquire-ruby-buildpack-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-ruby-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: ruby-buildpack-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-ruby-buildpack-release-candidate
    params:
      RELEASE_NAME: ruby-buildpack
  - task: update-additional-ops-files-ruby-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-ruby-buildpack-release-candidate
      release: ruby-buildpack-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-ruby-buildpack-release-candidate
    params:
      RELEASE_NAME: ruby-buildpack
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-ruby-buildpack-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-ruby-buildpack-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-ruby-buildpack-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-ruby-buildpack-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-ruby-buildpack
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-ruby-buildpack-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: ruby-buildpack
      on_success:
        do:
        - task: update-release-ruby-buildpack-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: ruby-buildpack-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-ruby-buildpack-develop
          params:
            RELEASE_NAME: ruby-buildpack
        - task: update-additional-ops-files-ruby-buildpack-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-ruby-buildpack-develop
            release: ruby-buildpack-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-ruby-buildpack-develop
          params:
            RELEASE_NAME: ruby-buildpack
        - task: update-compiled-releases-ops-file-ruby-buildpack-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-ruby-buildpack-develop
            release: ruby-buildpack-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-ruby-buildpack-develop
          params:
            RELEASE_NAME: ruby-buildpack
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: ruby-buildpack-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-ruby-buildpack-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-ruby-buildpack-release-candidate
            release: ruby-buildpack-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: ruby-buildpack
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: ruby-buildpack-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: ruby-buildpack-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/ruby-buildpack
              RELEASE_NAME: ruby-buildpack
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/ruby-buildpack-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-silk-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: silk-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-silk
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-silk-pre-dev-lock
      trigger: true
    - get: silk-release
      params:
        tarball: false
      passed:
      - acquire-silk-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-silk-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: silk-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-silk-release-candidate
    params:
      RELEASE_NAME: silk
  - task: update-additional-ops-files-silk-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-silk-release-candidate
      release: silk-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-silk-release-candidate
    params:
      RELEASE_NAME: silk
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-silk-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-silk-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-silk-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-silk-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-silk
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-silk-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: silk
      on_success:
        do:
        - task: update-release-silk-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: silk-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-silk-develop
          params:
            RELEASE_NAME: silk
        - task: update-additional-ops-files-silk-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-silk-develop
            release: silk-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-silk-develop
          params:
            RELEASE_NAME: silk
        - task: update-compiled-releases-ops-file-silk-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-silk-develop
            release: silk-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-silk-develop
          params:
            RELEASE_NAME: silk
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: silk-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-silk-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-silk-release-candidate
            release: silk-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: silk
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: silk-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: silk-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/silk
              RELEASE_NAME: silk
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/silk-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-staticfile-buildpack-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: staticfile-buildpack-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-staticfile-buildpack
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-staticfile-buildpack-pre-dev-lock
      trigger: true
    - get: staticfile-buildpack-release
      params:
        tarball: false
      passed:
      - acquire-staticfile-buildpack-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-staticfile-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: staticfile-buildpack-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-staticfile-buildpack-release-candidate
    params:
      RELEASE_NAME: staticfile-buildpack
  - task: update-additional-ops-files-staticfile-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-staticfile-buildpack-release-candidate
      release: staticfile-buildpack-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-staticfile-buildpack-release-candidate
    params:
      RELEASE_NAME: staticfile-buildpack
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-staticfile-buildpack-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-staticfile-buildpack-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-staticfile-buildpack-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-staticfile-buildpack-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-staticfile-buildpack
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-staticfile-buildpack-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: staticfile-buildpack
      on_success:
        do:
        - task: update-release-staticfile-buildpack-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: staticfile-buildpack-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-staticfile-buildpack-develop
          params:
            RELEASE_NAME: staticfile-buildpack
        - task: update-additional-ops-files-staticfile-buildpack-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-staticfile-buildpack-develop
            release: staticfile-buildpack-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-staticfile-buildpack-develop
          params:
            RELEASE_NAME: staticfile-buildpack
        - task: update-compiled-releases-ops-file-staticfile-buildpack-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-staticfile-buildpack-develop
            release: staticfile-buildpack-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-staticfile-buildpack-develop
          params:
            RELEASE_NAME: staticfile-buildpack
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: staticfile-buildpack-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-staticfile-buildpack-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-staticfile-buildpack-release-candidate
            release: staticfile-buildpack-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: staticfile-buildpack
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: staticfile-buildpack-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: staticfile-buildpack-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/staticfile-buildpack
              RELEASE_NAME: staticfile-buildpack
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/staticfile-buildpack-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-statsd-injector-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: statsd-injector-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-statsd-injector
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-statsd-injector-pre-dev-lock
      trigger: true
    - get: statsd-injector-release
      params:
        tarball: false
      passed:
      - acquire-statsd-injector-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-statsd-injector-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: statsd-injector-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-statsd-injector-release-candidate
    params:
      RELEASE_NAME: statsd-injector
  - task: update-additional-ops-files-statsd-injector-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-statsd-injector-release-candidate
      release: statsd-injector-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-statsd-injector-release-candidate
    params:
      RELEASE_NAME: statsd-injector
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-statsd-injector-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-statsd-injector-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-statsd-injector-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-statsd-injector-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-statsd-injector
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-statsd-injector-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: statsd-injector
      on_success:
        do:
        - task: update-release-statsd-injector-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: statsd-injector-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-statsd-injector-develop
          params:
            RELEASE_NAME: statsd-injector
        - task: update-additional-ops-files-statsd-injector-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-statsd-injector-develop
            release: statsd-injector-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-statsd-injector-develop
          params:
            RELEASE_NAME: statsd-injector
        - task: update-compiled-releases-ops-file-statsd-injector-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-statsd-injector-develop
            release: statsd-injector-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-statsd-injector-develop
          params:
            RELEASE_NAME: statsd-injector
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: statsd-injector-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-statsd-injector-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-statsd-injector-release-candidate
            release: statsd-injector-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: statsd-injector
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: statsd-injector-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: statsd-injector-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/statsd-injector
              RELEASE_NAME: statsd-injector
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/statsd-injector-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-uaa-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: uaa-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-uaa
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-uaa-pre-dev-lock
      trigger: true
    - get: uaa-release
      params:
        tarball: false
      passed:
      - acquire-uaa-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-uaa-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: uaa-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-uaa-release-candidate
    params:
      RELEASE_NAME: uaa
  - task: update-additional-ops-files-uaa-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-uaa-release-candidate
      release: uaa-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-uaa-release-candidate
    params:
      RELEASE_NAME: uaa
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-uaa-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-uaa-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-uaa-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-uaa-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-uaa
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-uaa-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: uaa
      on_success:
        do:
        - task: update-release-uaa-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: uaa-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-uaa-develop
          params:
            RELEASE_NAME: uaa
        - task: update-additional-ops-files-uaa-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-uaa-develop
            release: uaa-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-uaa-develop
          params:
            RELEASE_NAME: uaa
        - task: update-compiled-releases-ops-file-uaa-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-uaa-develop
            release: uaa-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-uaa-develop
          params:
            RELEASE_NAME: uaa
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: uaa-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-uaa-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-uaa-release-candidate
            release: uaa-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: uaa
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: uaa-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: uaa-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/uaa
              RELEASE_NAME: uaa
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/uaa-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-credhub-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: credhub-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-credhub
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-credhub-pre-dev-lock
      trigger: true
    - get: credhub-release
      params:
        tarball: false
      passed:
      - acquire-credhub-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-credhub-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: credhub-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-credhub-release-candidate
    params:
      RELEASE_NAME: credhub
  - task: update-additional-ops-files-credhub-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-credhub-release-candidate
      release: credhub-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-credhub-release-candidate
    params:
      RELEASE_NAME: credhub
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-credhub-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-credhub-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-credhub-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-credhub-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-credhub
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-credhub-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: credhub
      on_success:
        do:
        - task: update-release-credhub-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: credhub-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-credhub-develop
          params:
            RELEASE_NAME: credhub
        - task: update-additional-ops-files-credhub-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-credhub-develop
            release: credhub-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-credhub-develop
          params:
            RELEASE_NAME: credhub
        - task: update-compiled-releases-ops-file-credhub-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-credhub-develop
            release: credhub-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-credhub-develop
          params:
            RELEASE_NAME: credhub
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: credhub-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-credhub-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-credhub-release-candidate
            release: credhub-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: credhub
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: credhub-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: credhub-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/credhub
              RELEASE_NAME: credhub
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: pivotal-cf/credhub-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-cf-cli-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: cf-cli-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-cf-cli
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-cf-cli-pre-dev-lock
      trigger: true
    - get: cf-cli-release
      params:
        tarball: false
      passed:
      - acquire-cf-cli-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
      passed:
      - update-stemcell-and-recompile-releases
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-release-cf-cli-release-candidate
    file: runtime-ci/tasks/update-single-manifest-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-candidate
      release: cf-cli-release
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-cf-cli-release-candidate
    params:
      RELEASE_NAME: cf-cli
  - task: update-additional-ops-files-cf-cli-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: updated-cf-deployment-cf-cli-release-candidate
      release: cf-cli-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-cf-cli-release-candidate
    params:
      RELEASE_NAME: cf-cli
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: update-stemcell-for-deploy
        file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
        input_mapping:
          cf-deployment: updated-cf-deployment-cf-cli-release-candidate
        output_mapping:
          updated-cf-deployment: updated-cf-deployment-cf-cli-release-candidate-with-stemcell
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-cf-cli-release-candidate-with-stemcell
          ops-files: updated-cf-deployment-cf-cli-release-candidate-with-stemcell
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: export-compiled-release-cf-cli
        file: runtime-ci/tasks/export-compiled-release-tarball/task.yml
        input_mapping:
          bbl-state: relint-envs
          manifest: updated-cf-deployment-cf-cli-release-candidate-with-stemcell
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          RELEASE_NAME: cf-cli
      on_success:
        do:
        - task: update-release-cf-cli-develop
          file: runtime-ci/tasks/update-single-manifest-release/task.yml
          input_mapping:
            cf-deployment: cf-deployment-develop
            release: cf-cli-release
          output_mapping:
            updated-cf-deployment: updated-cf-deployment-cf-cli-develop
          params:
            RELEASE_NAME: cf-cli
        - task: update-additional-ops-files-cf-cli-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: updated-cf-deployment-cf-cli-develop
            release: cf-cli-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-cf-cli-develop
          params:
            RELEASE_NAME: cf-cli
        - task: update-compiled-releases-ops-file-cf-cli-develop
          file: runtime-ci/tasks/update-single-compiled-release/task.yml
          input_mapping:
            original-compiled-releases-ops-file: updated-cf-deployment-cf-cli-develop
            release: cf-cli-release
          output_mapping:
            updated-compiled-releases-ops-file: updated-cf-deployment-cf-cli-develop
          params:
            RELEASE_NAME: cf-cli
            ORIGINAL_OPS_FILE_PATH: operations/use-compiled-releases.yml
            UPDATED_OPS_FILE_PATH: operations/use-compiled-releases.yml
        - put: cf-cli-release-gcs
          params:
            file: compiled-release-tarball/*.tgz
            predefined_acl: publicRead
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-cf-cli-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-cf-cli-release-candidate
            release: cf-cli-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: cf-cli
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: cf-cli-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: cf-cli-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/cf-cli
              RELEASE_NAME: cf-cli
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: bosh-packages/cf-cli-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-backup-and-restore-sdk-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: backup-and-restore-sdk-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-backup-and-restore-sdk
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-backup-and-restore-sdk-pre-dev-lock
      trigger: true
    - get: backup-and-restore-sdk-release
      params:
        tarball: false
      passed:
      - acquire-backup-and-restore-sdk-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-backup-and-restore-sdk-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: backup-and-restore-sdk-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-backup-and-restore-sdk-release-candidate
    params:
      RELEASE_NAME: backup-and-restore-sdk
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-backup-and-restore-sdk-release-candidate
          ops-files: updated-cf-deployment-backup-and-restore-sdk-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-backup-and-restore-sdk-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: backup-and-restore-sdk-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-backup-and-restore-sdk-develop
          params:
            RELEASE_NAME: backup-and-restore-sdk
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-backup-and-restore-sdk-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-backup-and-restore-sdk-release-candidate
            release: backup-and-restore-sdk-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: backup-and-restore-sdk
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: backup-and-restore-sdk-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: backup-and-restore-sdk-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/backup-and-restore-sdk
              RELEASE_NAME: backup-and-restore-sdk
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry-incubator/backup-and-restore-sdk-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-bits-service-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: bits-service-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-bits-service
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-bits-service-pre-dev-lock
      trigger: true
    - get: bits-service-release
      params:
        tarball: false
      passed:
      - acquire-bits-service-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-bits-service-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: bits-service-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-bits-service-release-candidate
    params:
      RELEASE_NAME: bits-service
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-bits-service-release-candidate
          ops-files: updated-cf-deployment-bits-service-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-bits-service-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: bits-service-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-bits-service-develop
          params:
            RELEASE_NAME: bits-service
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-bits-service-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-bits-service-release-candidate
            release: bits-service-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: bits-service
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: bits-service-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: bits-service-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/bits-service
              RELEASE_NAME: bits-service
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry-incubator/bits-service-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-cf-app-sd-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: cf-app-sd-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-cf-app-sd
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-cf-app-sd-pre-dev-lock
      trigger: true
    - get: cf-app-sd-release
      params:
        tarball: false
      passed:
      - acquire-cf-app-sd-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-cf-app-sd-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: cf-app-sd-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-cf-app-sd-release-candidate
    params:
      RELEASE_NAME: cf-app-sd
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-cf-app-sd-release-candidate
          ops-files: updated-cf-deployment-cf-app-sd-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-cf-app-sd-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: cf-app-sd-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-cf-app-sd-develop
          params:
            RELEASE_NAME: cf-app-sd
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-cf-app-sd-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-cf-app-sd-release-candidate
            release: cf-app-sd-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: cf-app-sd
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: cf-app-sd-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: cf-app-sd-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/cf-app-sd
              RELEASE_NAME: cf-app-sd
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/cf-app-sd-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-haproxy-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: haproxy-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-haproxy
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-haproxy-pre-dev-lock
      trigger: true
    - get: haproxy-release
      params:
        tarball: false
      passed:
      - acquire-haproxy-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-haproxy-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: haproxy-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-haproxy-release-candidate
    params:
      RELEASE_NAME: haproxy
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-haproxy-release-candidate
          ops-files: updated-cf-deployment-haproxy-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
          VARS_FILES: environments/test/pre-dev/haproxy-vars.yml
      on_success:
        do:
        - task: update-additional-ops-files-haproxy-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: haproxy-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-haproxy-develop
          params:
            RELEASE_NAME: haproxy
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-haproxy-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-haproxy-release-candidate
            release: haproxy-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: haproxy
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: haproxy-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: haproxy-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/haproxy
              RELEASE_NAME: haproxy
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry-incubator/haproxy-boshrelease
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-mapfs-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: mapfs-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-mapfs
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-mapfs-pre-dev-lock
      trigger: true
    - get: mapfs-release
      params:
        tarball: false
      passed:
      - acquire-mapfs-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-mapfs-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: mapfs-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-mapfs-release-candidate
    params:
      RELEASE_NAME: mapfs
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-mapfs-release-candidate
          ops-files: updated-cf-deployment-mapfs-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-mapfs-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: mapfs-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-mapfs-develop
          params:
            RELEASE_NAME: mapfs
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-mapfs-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-mapfs-release-candidate
            release: mapfs-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: mapfs
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: mapfs-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: mapfs-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/mapfs
              RELEASE_NAME: mapfs
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/mapfs-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-nfs-volume-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: nfs-volume-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-nfs-volume
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-nfs-volume-pre-dev-lock
      trigger: true
    - get: nfs-volume-release
      params:
        tarball: false
      passed:
      - acquire-nfs-volume-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-nfs-volume-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: nfs-volume-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-nfs-volume-release-candidate
    params:
      RELEASE_NAME: nfs-volume
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-nfs-volume-release-candidate
          ops-files: updated-cf-deployment-nfs-volume-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-nfs-volume-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: nfs-volume-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-nfs-volume-develop
          params:
            RELEASE_NAME: nfs-volume
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-nfs-volume-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-nfs-volume-release-candidate
            release: nfs-volume-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: nfs-volume
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: nfs-volume-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: nfs-volume-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/nfs-volume
              RELEASE_NAME: nfs-volume
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/nfs-volume-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-smb-volume-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: smb-volume-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-smb-volume
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-smb-volume-pre-dev-lock
      trigger: true
    - get: smb-volume-release
      params:
        tarball: false
      passed:
      - acquire-smb-volume-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-smb-volume-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: smb-volume-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-smb-volume-release-candidate
    params:
      RELEASE_NAME: smb-volume
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-smb-volume-release-candidate
          ops-files: updated-cf-deployment-smb-volume-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-smb-volume-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: smb-volume-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-smb-volume-develop
          params:
            RELEASE_NAME: smb-volume
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-smb-volume-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-smb-volume-release-candidate
            release: smb-volume-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: smb-volume
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: smb-volume-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: smb-volume-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/smb-volume
              RELEASE_NAME: smb-volume
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/smb-volume-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-postgres-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: postgres-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-postgres
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-postgres-pre-dev-lock
      trigger: true
    - get: postgres-release
      params:
        tarball: false
      passed:
      - acquire-postgres-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-postgres-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: postgres-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-postgres-release-candidate
    params:
      RELEASE_NAME: postgres
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-postgres-release-candidate
          ops-files: updated-cf-deployment-postgres-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-postgres-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: postgres-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-postgres-develop
          params:
            RELEASE_NAME: postgres
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-postgres-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-postgres-release-candidate
            release: postgres-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: postgres
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: postgres-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: postgres-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/postgres
              RELEASE_NAME: postgres
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/postgres-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-syslog-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: syslog-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-syslog
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-syslog-pre-dev-lock
      trigger: true
    - get: syslog-release
      params:
        tarball: false
      passed:
      - acquire-syslog-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-syslog-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: syslog-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-syslog-release-candidate
    params:
      RELEASE_NAME: syslog
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-syslog-release-candidate
          ops-files: updated-cf-deployment-syslog-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
          VARS_FILES: operations/addons/example-vars-files/vars-enable-component-syslog.yml
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-syslog-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: syslog-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-syslog-develop
          params:
            RELEASE_NAME: syslog
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-syslog-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-syslog-release-candidate
            release: syslog-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: syslog
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: syslog-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: syslog-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/syslog
              RELEASE_NAME: syslog
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/syslog-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-windows-syslog-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: windows-syslog-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-windows-syslog
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-windows-syslog-pre-dev-lock
      trigger: true
    - get: windows-syslog-release
      params:
        tarball: false
      passed:
      - acquire-windows-syslog-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-windows-syslog-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: windows-syslog-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-windows-syslog-release-candidate
    params:
      RELEASE_NAME: windows-syslog
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-windows-syslog-release-candidate
          ops-files: updated-cf-deployment-windows-syslog-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
          VARS_FILES: environments/test/pre-dev/windows-enable-component-syslog-vars.yml
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-windows-syslog-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: windows-syslog-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-windows-syslog-develop
          params:
            RELEASE_NAME: windows-syslog
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-windows-syslog-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-windows-syslog-release-candidate
            release: windows-syslog-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: windows-syslog
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: windows-syslog-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: windows-syslog-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/windows-syslog
              RELEASE_NAME: windows-syslog
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/windows-syslog-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-hwc-buildpack-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: hwc-buildpack-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-hwc-buildpack
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-hwc-buildpack-pre-dev-lock
      trigger: true
    - get: hwc-buildpack-release
      params:
        tarball: false
      passed:
      - acquire-hwc-buildpack-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-hwc-buildpack-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: hwc-buildpack-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-hwc-buildpack-release-candidate
    params:
      RELEASE_NAME: hwc-buildpack
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-hwc-buildpack-release-candidate
          ops-files: updated-cf-deployment-hwc-buildpack-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-hwc-buildpack-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: hwc-buildpack-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-hwc-buildpack-develop
          params:
            RELEASE_NAME: hwc-buildpack
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-hwc-buildpack-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-hwc-buildpack-release-candidate
            release: hwc-buildpack-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: hwc-buildpack
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: hwc-buildpack-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: hwc-buildpack-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/hwc-buildpack
              RELEASE_NAME: hwc-buildpack
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry-incubator/hwc-buildpack-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-windows-utilities-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: windows-utilities-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-windows-utilities
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-windows-utilities-pre-dev-lock
      trigger: true
    - get: windows-utilities-release
      params:
        tarball: false
      passed:
      - acquire-windows-utilities-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-windows-utilities-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: windows-utilities-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-windows-utilities-release-candidate
    params:
      RELEASE_NAME: windows-utilities
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-windows-utilities-release-candidate
          ops-files: updated-cf-deployment-windows-utilities-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-windows-utilities-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: windows-utilities-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-windows-utilities-develop
          params:
            RELEASE_NAME: windows-utilities
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-windows-utilities-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-windows-utilities-release-candidate
            release: windows-utilities-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: windows-utilities
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: windows-utilities-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: windows-utilities-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/windows-utilities
              RELEASE_NAME: windows-utilities
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry-incubator/windows-utilities-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-garden-windows-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: garden-windows-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-garden-windows
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-garden-windows-pre-dev-lock
      trigger: true
    - get: garden-windows-release
      params:
        tarball: false
      passed:
      - acquire-garden-windows-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-garden-windows-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: garden-windows-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-garden-windows-release-candidate
    params:
      RELEASE_NAME: garden-windows
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-garden-windows-release-candidate
          ops-files: updated-cf-deployment-garden-windows-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-garden-windows-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: garden-windows-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-garden-windows-develop
          params:
            RELEASE_NAME: garden-windows
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-garden-windows-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-garden-windows-release-candidate
            release: garden-windows-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: garden-windows
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: garden-windows-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: garden-windows-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/garden-windows
              RELEASE_NAME: garden-windows
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry-incubator/garden-windows-bosh-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-winc-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: winc-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-winc
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-winc-pre-dev-lock
      trigger: true
    - get: winc-release
      params:
        tarball: false
      passed:
      - acquire-winc-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-winc-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: winc-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-winc-release-candidate
    params:
      RELEASE_NAME: winc
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-winc-release-candidate
          ops-files: updated-cf-deployment-winc-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-winc-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: winc-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-winc-develop
          params:
            RELEASE_NAME: winc
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-winc-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-winc-release-candidate
            release: winc-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: winc
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: winc-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: winc-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/winc
              RELEASE_NAME: winc
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry-incubator/winc-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-windows1803fs-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: windows1803fs-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-windows1803fs
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-windows1803fs-pre-dev-lock
      trigger: true
    - get: windows1803fs-release
      params:
        tarball: false
      passed:
      - acquire-windows1803fs-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-windows1803fs-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: windows1803fs-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-windows1803fs-release-candidate
    params:
      RELEASE_NAME: windows1803fs
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-windows1803fs-release-candidate
          ops-files: updated-cf-deployment-windows1803fs-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-windows1803fs-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: windows1803fs-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-windows1803fs-develop
          params:
            RELEASE_NAME: windows1803fs
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-windows1803fs-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-windows1803fs-release-candidate
            release: windows1803fs-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: windows1803fs
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: windows1803fs-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: windows1803fs-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/windows1803fs
              RELEASE_NAME: windows1803fs
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/windows1803fs-online-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-windows2016fs-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: windows2016fs-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-windows2016fs
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-windows2016fs-pre-dev-lock
      trigger: true
    - get: windows2016fs-release
      params:
        tarball: false
      passed:
      - acquire-windows2016fs-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-windows2016fs-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: windows2016fs-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-windows2016fs-release-candidate
    params:
      RELEASE_NAME: windows2016fs
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-windows2016fs-release-candidate
          ops-files: updated-cf-deployment-windows2016fs-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-windows2016fs-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: windows2016fs-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-windows2016fs-develop
          params:
            RELEASE_NAME: windows2016fs
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-windows2016fs-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-windows2016fs-release-candidate
            release: windows2016fs-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: windows2016fs
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: windows2016fs-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: windows2016fs-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/windows2016fs
              RELEASE_NAME: windows2016fs
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry-incubator/windows2016fs-online-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-windowsfs-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: windowsfs-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-windowsfs
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-windowsfs-pre-dev-lock
      trigger: true
    - get: windowsfs-release
      params:
        tarball: false
      passed:
      - acquire-windowsfs-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-windowsfs-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: windowsfs-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-windowsfs-release-candidate
    params:
      RELEASE_NAME: windowsfs
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-windowsfs-release-candidate
          ops-files: updated-cf-deployment-windowsfs-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |-
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
            operations/windows2019-cell.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-windowsfs-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: windowsfs-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-windowsfs-develop
          params:
            RELEASE_NAME: windowsfs
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-windowsfs-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-windowsfs-release-candidate
            release: windowsfs-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: windowsfs
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: windowsfs-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: windowsfs-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/windowsfs
              RELEASE_NAME: windowsfs
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/windowsfs-online-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-node-exporter-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: node-exporter-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-node-exporter
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-node-exporter-pre-dev-lock
      trigger: true
    - get: node-exporter-release
      params:
        tarball: false
      passed:
      - acquire-node-exporter-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-node-exporter-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: node-exporter-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-node-exporter-release-candidate
    params:
      RELEASE_NAME: node-exporter
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-node-exporter-release-candidate
          ops-files: updated-cf-deployment-node-exporter-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-node-exporter-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: node-exporter-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-node-exporter-develop
          params:
            RELEASE_NAME: node-exporter
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-node-exporter-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-node-exporter-release-candidate
            release: node-exporter-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: node-exporter
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: node-exporter-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: node-exporter-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/node-exporter
              RELEASE_NAME: node-exporter
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry-community/node-exporter-boshrelease
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-system-metrics-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: system-metrics-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-system-metrics
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-system-metrics-pre-dev-lock
      trigger: true
    - get: system-metrics-release
      params:
        tarball: false
      passed:
      - acquire-system-metrics-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-system-metrics-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: system-metrics-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-system-metrics-release-candidate
    params:
      RELEASE_NAME: system-metrics
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-system-metrics-release-candidate
          ops-files: updated-cf-deployment-system-metrics-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-system-metrics-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: system-metrics-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-system-metrics-develop
          params:
            RELEASE_NAME: system-metrics
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-system-metrics-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-system-metrics-release-candidate
            release: system-metrics-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: system-metrics
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: system-metrics-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: system-metrics-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/system-metrics
              RELEASE_NAME: system-metrics
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/system-metrics-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-system-metrics-scraper-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: system-metrics-scraper-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-system-metrics-scraper
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-system-metrics-scraper-pre-dev-lock
      trigger: true
    - get: system-metrics-scraper-release
      params:
        tarball: false
      passed:
      - acquire-system-metrics-scraper-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-system-metrics-scraper-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: system-metrics-scraper-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-system-metrics-scraper-release-candidate
    params:
      RELEASE_NAME: system-metrics-scraper
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-system-metrics-scraper-release-candidate
          ops-files: updated-cf-deployment-system-metrics-scraper-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-system-metrics-scraper-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: system-metrics-scraper-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-system-metrics-scraper-develop
          params:
            RELEASE_NAME: system-metrics-scraper
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-system-metrics-scraper-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-system-metrics-scraper-release-candidate
            release: system-metrics-scraper-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: system-metrics-scraper
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: system-metrics-scraper-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: system-metrics-scraper-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/system-metrics-scraper
              RELEASE_NAME: system-metrics-scraper
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/system-metrics-scraper-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-metric-store-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: metric-store-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-metric-store
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-metric-store-pre-dev-lock
      trigger: true
    - get: metric-store-release
      params:
        tarball: false
      passed:
      - acquire-metric-store-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-metric-store-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: metric-store-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-metric-store-release-candidate
    params:
      RELEASE_NAME: metric-store
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-metric-store-release-candidate
          ops-files: updated-cf-deployment-metric-store-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-metric-store-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: metric-store-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-metric-store-develop
          params:
            RELEASE_NAME: metric-store
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-metric-store-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-metric-store-release-candidate
            release: metric-store-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: metric-store
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: metric-store-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: metric-store-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/metric-store
              RELEASE_NAME: metric-store
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/metric-store-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-envoy-nginx-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: envoy-nginx-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-envoy-nginx
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-envoy-nginx-pre-dev-lock
      trigger: true
    - get: envoy-nginx-release
      params:
        tarball: false
      passed:
      - acquire-envoy-nginx-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-envoy-nginx-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: envoy-nginx-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-envoy-nginx-release-candidate
    params:
      RELEASE_NAME: envoy-nginx
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-envoy-nginx-release-candidate
          ops-files: updated-cf-deployment-envoy-nginx-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |-
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
            operations/windows2019-cell.yml
            operations/use-online-windows2019fs.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-envoy-nginx-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: envoy-nginx-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-envoy-nginx-develop
          params:
            RELEASE_NAME: envoy-nginx
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-envoy-nginx-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-envoy-nginx-release-candidate
            release: envoy-nginx-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: envoy-nginx
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: envoy-nginx-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: envoy-nginx-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/envoy-nginx
              RELEASE_NAME: envoy-nginx
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry-incubator/envoy-nginx-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: acquire-metrics-discovery-pre-dev-lock
  public: true
  plan:
  - in_parallel:
    - get: metrics-discovery-release
      trigger: true
      params:
        tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
- name: update-metrics-discovery
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-metrics-discovery-pre-dev-lock
      trigger: true
    - get: metrics-discovery-release
      params:
        tarball: false
      passed:
      - acquire-metrics-discovery-pre-dev-lock
    - get: cf-deployment-release-candidate
    - get: cf-deployment-develop
    - get: stemcell
      params:
        tarball: false
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: relint-team
  - task: update-additional-ops-files-metrics-discovery-release-candidate
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-release-candidate
      release: metrics-discovery-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-metrics-discovery-release-candidate
    params:
      RELEASE_NAME: metrics-discovery
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - task: add-gcp-dns
      file: runtime-ci/tasks/manage-gcp-dns/task.yml
      input_mapping:
        bbl-state: relint-envs
        pool-lock: pre-dev-pool
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
        GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
        GCP_DNS_ZONE_NAME: test-relint-rocks
        ACTION: add
    - do:
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-release-candidate
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: runtime-ci/tasks/bosh-deploy-with-first-ops/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-metrics-discovery-release-candidate
          ops-files: updated-cf-deployment-metrics-discovery-release-candidate
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
            operations/use-compiled-releases.yml
            operations/experimental/use-compiled-releases-windows.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          cats-integration-config: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      on_success:
        do:
        - task: update-additional-ops-files-metrics-discovery-develop
          file: runtime-ci/tasks/update-single-opsfile-release/task.yml
          input_mapping:
            original-ops-file: cf-deployment-develop
            release: metrics-discovery-release
          output_mapping:
            updated-ops-file: updated-cf-deployment-metrics-discovery-develop
          params:
            RELEASE_NAME: metrics-discovery
        - put: cf-deployment-develop
          params:
            rebase: true
            repository: updated-cf-deployment-metrics-discovery-develop
      on_failure:
        do:
        - task: push-to-release-branch
          file: runtime-ci/tasks/push-to-release-branch/task.yml
          input_mapping:
            updated-cf-deployment: updated-cf-deployment-metrics-discovery-release-candidate
            release: metrics-discovery-release
          params:
            DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
            RELEASE_NAME: metrics-discovery
        - task: retrieve-bosh-logs
          file: runtime-ci/tasks/retrieve-bosh-logs/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        - put: metrics-discovery-component-bump-logs-gcs
          params:
            file: bosh-logs/cf-*.tgz
        ensure:
          do:
          - task: create-slack-message
            file: runtime-ci/tasks/create-slack-message/task.yml
            input_mapping:
              release: metrics-discovery-release
            params:
              BOSH_LOGS_PREFIX: https://storage.cloud.google.com/component-bump-logs/metrics-discovery
              RELEASE_NAME: metrics-discovery
          - task: lookup-slack-channel-for-release-owner
            file: runtime-ci/tasks/lookup-slack-channel-for-release-owner/task.yml
            params:
              RELEASE_REPOSITORY: cloudfoundry/metrics-discovery-release
          - put: slack-alert
            params:
              channel_file: slack-channel/channel.txt
              icon_emoji: ':cloudfoundrylogo:'
              text: |
                $TEXT_FILE_CONTENT

                CI job: https://release-integration.ci.cf-app.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

                If you're unfamiliar with the update-release pre-validation, please review the following FAQ: https://docs.google.com/document/d/1dUIk2HWbUzdxWs-pNZ-cCqH7CuSNDBixIUoXIFkFpz0
              text_file: slack-message/message.txt
              username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: update-datadog-firehose-nozzle
  public: true
  plan:
  - in_parallel:
    - get: datadog-firehose-nozzle-release
      trigger: true
      params:
        tarball: false
    - get: cf-deployment-develop
    - get: runtime-ci
  - task: update-additional-ops-files-datadog-firehose-nozzle-develop
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-develop
      release: datadog-firehose-nozzle-release
    output_mapping:
      updated-ops-file: updated-cf-deployment-datadog-firehose-nozzle-develop
    params:
      RELEASE_NAME: datadog-firehose-nozzle
  - put: cf-deployment-develop
    params:
      rebase: true
      repository: updated-cf-deployment-datadog-firehose-nozzle-develop
- name: update-windows2012R2-stemcell
  public: true
  plan:
  - in_parallel:
    - get: runtime-ci
    - get: cf-deployment-develop
    - get: windows2012R2-stemcell
      trigger: true
      params:
        tarball: false
  - task: update-windows-stemcell-ops
    file: runtime-ci/tasks/update-windows-stemcell-ops/task.yml
    input_mapping:
      ops-files: cf-deployment-develop
      windows-stemcell: windows2012R2-stemcell
    params:
      ORIGINAL_WINDOWS_OPS_FILE_PATH: operations/windows2012R2-cell.yml
      UPDATED_WINDOWS_OPS_FILE_PATH: operations/windows2012R2-cell.yml
  - put: cf-deployment-develop
    params:
      rebase: true
      repository: updated-stemcell-ops-file
- name: update-windows2016-stemcell
  public: true
  plan:
  - in_parallel:
    - get: runtime-ci
    - get: cf-deployment-develop
    - get: windows2016-stemcell
      trigger: true
      params:
        tarball: false
  - task: update-windows-stemcell-ops
    file: runtime-ci/tasks/update-windows-stemcell-ops/task.yml
    input_mapping:
      ops-files: cf-deployment-develop
      windows-stemcell: windows2016-stemcell
    params:
      ORIGINAL_WINDOWS_OPS_FILE_PATH: operations/windows2016-cell.yml
      UPDATED_WINDOWS_OPS_FILE_PATH: operations/windows2016-cell.yml
  - put: cf-deployment-develop
    params:
      rebase: true
      repository: updated-stemcell-ops-file
- name: update-windows1803-stemcell
  public: true
  plan:
  - in_parallel:
    - get: runtime-ci
    - get: cf-deployment-develop
    - get: windows1803-stemcell
      trigger: true
      params:
        tarball: false
  - task: update-windows-stemcell-ops
    file: runtime-ci/tasks/update-windows-stemcell-ops/task.yml
    input_mapping:
      ops-files: cf-deployment-develop
      windows-stemcell: windows1803-stemcell
    params:
      ORIGINAL_WINDOWS_OPS_FILE_PATH: operations/windows1803-cell.yml
      UPDATED_WINDOWS_OPS_FILE_PATH: operations/windows1803-cell.yml
  - put: cf-deployment-develop
    params:
      rebase: true
      repository: updated-stemcell-ops-file
- name: update-windows2019-stemcell
  public: true
  plan:
  - in_parallel:
    - get: runtime-ci
    - get: cf-deployment-develop
    - get: windows2019-stemcell
      trigger: true
      params:
        tarball: false
  - task: update-windows-stemcell-ops
    file: runtime-ci/tasks/update-windows-stemcell-ops/task.yml
    input_mapping:
      ops-files: cf-deployment-develop
      windows-stemcell: windows2019-stemcell
    params:
      ORIGINAL_WINDOWS_OPS_FILE_PATH: operations/windows2019-cell.yml
      UPDATED_WINDOWS_OPS_FILE_PATH: operations/windows2019-cell.yml
  - put: cf-deployment-develop
    params:
      rebase: true
      repository: updated-stemcell-ops-file
- name: detect-stemcell-bump
  plan:
  - in_parallel:
    - get: stemcell
      trigger: true
    - get: cf-deployment-master
    - get: runtime-ci
  - task: detect-stemcell-bump
    file: runtime-ci/tasks/detect-stemcell-bump/task.yml
    input_mapping:
      cf-deployment: cf-deployment-master
  - put: stemcell-version-bump-detect
    params:
      type_file: stemcell-bump-type/result
      version_file: stemcell/version
- name: acquire-all-pre-dev-locks
  public: true
  plan:
  - in_parallel:
    - get: stemcell-version-bump-major
      trigger: true
    - get: stemcell
      passed:
      - detect-stemcell-bump
      params:
        tarball: false
  - in_parallel:
    - put: pre-dev-dagobah
      params:
        claim: pre-dev-dagobah
    - put: pre-dev-endor
      params:
        claim: pre-dev-endor
    - put: pre-dev-hoth
      params:
        claim: pre-dev-hoth
    - put: pre-dev-tatooine
      params:
        claim: pre-dev-tatooine
  - put: slack-alert
    params:
      icon_emoji: ':cloudfoundrylogo:'
      text: |
        Starting to bump to new major stemcell: $TEXT_FILE_CONTENT
      text_file: stemcell/version
      username: Release Integration
- name: update-stemcell-and-recompile-releases
  public: true
  plan:
  - do:
    - in_parallel:
      - get: runtime-ci
      - get: relint-envs
      - get: cf-deployment-develop
      - get: cf-deployment-concourse-tasks
      - get: stemcell
        params:
          tarball: false
        passed:
        - acquire-all-pre-dev-locks
      - get: pre-dev-dagobah
        passed:
        - acquire-all-pre-dev-locks
        trigger: true
      - get: pre-dev-endor
        passed:
        - acquire-all-pre-dev-locks
        trigger: true
      - get: pre-dev-hoth
        passed:
        - acquire-all-pre-dev-locks
        trigger: true
      - get: pre-dev-tatooine
        passed:
        - acquire-all-pre-dev-locks
        trigger: true
    - do:
      - task: upload-stemcell
        file: runtime-ci/tasks/bosh-upload-stemcell/task.yml
        input_mapping:
          bbl-state: relint-envs
        params:
          BBL_STATE_DIR: environments/test/greengrass/bbl-state
      - task: guarantee-no-existing-deployments
        file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
        input_mapping:
          bbl-state: relint-envs
        params:
          BBL_STATE_DIR: environments/test/greengrass/bbl-state
          DELETE_ALL_DEPLOYMENTS: true
          IGNORE_ERRORS: true
        attempts: 3
      - task: deploy-all-releases
        file: runtime-ci/tasks/deploy-all-releases/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: cf-deployment-develop
        params:
          BBL_STATE_DIR: environments/test/greengrass/bbl-state
      - task: export-all-compiled-release-tarballs
        file: runtime-ci/tasks/export-all-compiled-release-tarballs/task.yml
        input_mapping:
          bbl-state: relint-envs
        params:
          BBL_STATE_DIR: environments/test/greengrass/bbl-state
          BOSH_DEPLOYMENT: cf-compilation
      ensure:
        do:
        - task: delete-all-deployments
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
          params:
            BBL_STATE_DIR: environments/test/greengrass/bbl-state
            DELETE_ALL_DEPLOYMENTS: true
            IGNORE_ERRORS: true
          attempts: 3
        - task: run-bosh-cleanup
          file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
          input_mapping:
            bbl-state: relint-envs
          params:
            BBL_STATE_DIR: environments/test/greengrass/bbl-state
    - task: update-stemcell
      file: runtime-ci/tasks/update-stemcell/task.yml
      input_mapping:
        cf-deployment: cf-deployment-develop
    - in_parallel:
      - put: binary-buildpack-release-gcs
        params:
          file: compiled-releases/binary-buildpack-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: bosh-dns-aliases-release-gcs
        params:
          file: compiled-releases/bosh-dns-aliases-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: bpm-release-gcs
        params:
          file: compiled-releases/bpm-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: capi-release-gcs
        params:
          file: compiled-releases/capi-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: cf-networking-release-gcs
        params:
          file: compiled-releases/cf-networking-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: cf-smoke-tests-release-gcs
        params:
          file: compiled-releases/cf-smoke-tests-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: cf-syslog-drain-release-gcs
        params:
          file: compiled-releases/cf-syslog-drain-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: cflinuxfs3-release-gcs
        params:
          file: compiled-releases/cflinuxfs3-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: diego-release-gcs
        params:
          file: compiled-releases/diego-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: dotnet-core-buildpack-release-gcs
        params:
          file: compiled-releases/dotnet-core-buildpack-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: garden-runc-release-gcs
        params:
          file: compiled-releases/garden-runc-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: go-buildpack-release-gcs
        params:
          file: compiled-releases/go-buildpack-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: java-buildpack-release-gcs
        params:
          file: compiled-releases/java-buildpack-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: log-cache-release-gcs
        params:
          file: compiled-releases/log-cache-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: loggregator-release-gcs
        params:
          file: compiled-releases/loggregator-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: loggregator-agent-release-gcs
        params:
          file: compiled-releases/loggregator-agent-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: nats-release-gcs
        params:
          file: compiled-releases/nats-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: nginx-buildpack-release-gcs
        params:
          file: compiled-releases/nginx-buildpack-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: nodejs-buildpack-release-gcs
        params:
          file: compiled-releases/nodejs-buildpack-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: php-buildpack-release-gcs
        params:
          file: compiled-releases/php-buildpack-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: python-buildpack-release-gcs
        params:
          file: compiled-releases/python-buildpack-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: pxc-release-gcs
        params:
          file: compiled-releases/pxc-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: r-buildpack-release-gcs
        params:
          file: compiled-releases/r-buildpack-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: routing-release-gcs
        params:
          file: compiled-releases/routing-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: ruby-buildpack-release-gcs
        params:
          file: compiled-releases/ruby-buildpack-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: silk-release-gcs
        params:
          file: compiled-releases/silk-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: staticfile-buildpack-release-gcs
        params:
          file: compiled-releases/staticfile-buildpack-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: statsd-injector-release-gcs
        params:
          file: compiled-releases/statsd-injector-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: uaa-release-gcs
        params:
          file: compiled-releases/uaa-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: credhub-release-gcs
        params:
          file: compiled-releases/credhub-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
      - put: cf-cli-release-gcs
        params:
          file: compiled-releases/cf-cli-[0-9]*.tgz
          predefined_acl: publicRead
        get_params:
          skip_download: true
        attempts: 3
    - put: cf-deployment-develop
      params:
        rebase: true
        repository: updated-cf-deployment
    ensure:
      in_parallel:
      - put: pre-dev-dagobah
        params:
          release: pre-dev-dagobah
      - put: pre-dev-endor
        params:
          release: pre-dev-endor
      - put: pre-dev-hoth
        params:
          release: pre-dev-hoth
      - put: pre-dev-tatooine
        params:
          release: pre-dev-tatooine
- name: acquire-pre-dev-lock-for-update-stemcell-minor
  public: true
  plan:
  - get: stemcell-version-bump-minor
    trigger: true
  - get: stemcell
    passed:
    - detect-stemcell-bump
    params:
      tarball: false
  - put: pre-dev-pool
    params:
      acquire: true
  - put: slack-alert
    params:
      icon_emoji: ':cloudfoundrylogo:'
      text: |
        Starting to bump to new minor stemcell: $TEXT_FILE_CONTENT
      text_file: stemcell/version
      username: Release Integration
- name: update-stemcell-minor
  public: true
  plan:
  - in_parallel:
    - get: pre-dev-pool
      passed:
      - acquire-pre-dev-lock-for-update-stemcell-minor
      trigger: true
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment-master
    - get: relint-envs
    - get: runtime-ci
    - get: stemcell
      params:
        tarball: false
      passed:
      - acquire-pre-dev-lock-for-update-stemcell-minor
    - get: cf-deployment-version
      params:
        bump: minor
  - task: update-stemcell-minor
    file: runtime-ci/tasks/update-base-manifest-stemcell/task.yml
    input_mapping:
      cf-deployment: cf-deployment-master
    output_mapping:
      updated-cf-deployment: updated-cf-deployment-master
  - do:
    - task: bbl-up
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_JSON_CONFIG: pool-lock/metadata
      input_mapping:
        bbl-state: relint-envs
        bbl-config: relint-envs
        pool-lock: pre-dev-pool
      on_failure:
        do:
        - task: bbl-cleanup-leftovers
          file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
          input_mapping:
            bbl-state: updated-bbl-state
            pool-lock: pre-dev-pool
          output_mapping:
            updated-bbl-state: clean-bbl-state
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
        ensure:
          put: relint-envs
          params:
            repository: clean-bbl-state
            rebase: true
      on_success:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - do:
      - task: add-gcp-dns
        file: runtime-ci/tasks/manage-gcp-dns/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
          GCP_DNS_ZONE_NAME: test-relint-rocks
          ACTION: add
      - task: combine-vars-files
        file: runtime-ci/tasks/combine-inputs/task.yml
        input_mapping:
          first-input: cf-deployment-master
          second-input: relint-envs
        output_mapping:
          combined-inputs: combined-vars-files
      - task: deploy-cf
        file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
        input_mapping:
          bbl-state: relint-envs
          cf-deployment: updated-cf-deployment-master
          ops-files: updated-cf-deployment-master
          vars-files: combined-vars-files
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          OPS_FILES: |
            operations/scale-to-one-az.yml
            operations/use-compiled-releases.yml
            operations/experimental/fast-deploy-with-downtime-and-danger.yml
          REGENERATE_CREDENTIALS: false
          BOSH_DEPLOY_ARGS: --parallel 50
      - task: ensure-api-healthy
        file: runtime-ci/tasks/ensure-api-healthy/task.yml
        input_mapping:
          pool-lock: pre-dev-pool
          cats-integration-config: relint-envs
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
      - task: run-errand-smoke-tests
        file: cf-deployment-concourse-tasks/run-errand/task.yml
        input_mapping:
          bbl-state: relint-envs
          pool-lock: pre-dev-pool
        params:
          BBL_JSON_CONFIG: pool-lock/metadata
          ERRAND_NAME: smoke-tests
      - task: generate-cf-deployment-release-notes-template
        file: runtime-ci/tasks/cf-deployment-minor-stemcell-bump-release-notes/task.yml
        input_mapping:
          release-version: cf-deployment-version
      - task: update-cf-deployment-manifest-version
        file: runtime-ci/tasks/record-cfd-version-in-manifest/task.yml
        input_mapping:
          cf-deployment-release-candidate: updated-cf-deployment-master
        output_mapping:
          cf-deployment-rc-with-updated-version: cf-deployment-master-with-updated-manifest-version
      - put: cf-deployment-master
        params:
          repository: cf-deployment-master-with-updated-manifest-version
          tag: cf-deployment-version/version
          tag_prefix: v
      - put: cf-deployment-release
        params:
          name: cf-deployment-minor-stemcell-bump-release-notes/name.txt
          tag: cf-deployment-version/version
          tag_prefix: v
          body: cf-deployment-minor-stemcell-bump-release-notes/body.txt
      - put: cf-deployment-version
        params:
          bump: minor
      - put: cf-deployment-develop
        params:
          repository: cf-deployment-master-with-updated-manifest-version
          merge: true
      - put: slack-alert
        params:
          icon_emoji: ':cloudfoundrylogo:'
          text: |
            Releasing new minor stemcell bump in v$TEXT_FILE_CONTENT of cf-deployment

            https://github.com/cloudfoundry/cf-deployment/releases/tag/v$TEXT_FILE_CONTENT
          text_file: cf-deployment-version/version
          username: Release Integration
      ensure:
        do:
        - task: delete-deployment
          file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            IGNORE_ERRORS: true
          attempts: 3
        - task: remove-gcp-dns
          file: runtime-ci/tasks/manage-gcp-dns/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
            GCP_DNS_SERVICE_ACCOUNT_KEY: ((concourse_gcp_service_account_json))
            GCP_DNS_ZONE_NAME: test-relint-rocks
            ACTION: remove
        - task: bbl-down
          file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
          input_mapping:
            bbl-state: relint-envs
            pool-lock: pre-dev-pool
          params:
            BBL_JSON_CONFIG: pool-lock/metadata
          on_failure:
            do:
            - task: bbl-cleanup-leftovers
              file: runtime-ci/tasks/bbl-cleanup-leftovers/task.yml
              input_mapping:
                bbl-state: updated-bbl-state
                pool-lock: pre-dev-pool
              output_mapping:
                updated-bbl-state: clean-bbl-state
              params:
                BBL_JSON_CONFIG: pool-lock/metadata
            ensure:
              put: relint-envs
              params:
                repository: clean-bbl-state
                rebase: true
          on_success:
            put: relint-envs
            params:
              repository: updated-bbl-state
              rebase: true
    ensure:
      do:
      - put: pre-dev-pool
        params:
          release: pre-dev-pool
- name: update-windows1803fs-offline-release
  serial: true
  public: true
  plan:
  - in_parallel:
    - get: runtime-ci
    - get: relint-envs
    - get: cf-deployment-develop
    - get: cf-deployment-concourse-tasks
      params:
        tarball: false
    - get: windows1803fs-offline-release
      trigger: true
      params:
        tarball: false
    - get: windows2016-stemcell
  - task: update-windows-releases
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-develop
      release: windows1803fs-offline-release
    params:
      RELEASE_NAME: windows1803fs
      ORIGINAL_OPS_FILE_PATH: operations/use-offline-windows1803fs.yml
      UPDATED_OPS_FILE_PATH: operations/use-offline-windows1803fs.yml
  - put: cf-deployment-develop
    params:
      rebase: true
      repository: updated-ops-file
- name: update-windows2016fs-offline-release
  serial: true
  public: true
  plan:
  - in_parallel:
    - get: runtime-ci
    - get: relint-envs
    - get: cf-deployment-develop
    - get: cf-deployment-concourse-tasks
      params:
        tarball: false
    - get: windows2016fs-offline-release
      trigger: true
      params:
        tarball: false
    - get: windows2016-stemcell
  - task: update-windows-releases
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-develop
      release: windows2016fs-offline-release
    params:
      RELEASE_NAME: windows2016fs
      ORIGINAL_OPS_FILE_PATH: operations/use-offline-windows2016fs.yml
      UPDATED_OPS_FILE_PATH: operations/use-offline-windows2016fs.yml
  - put: cf-deployment-develop
    params:
      rebase: true
      repository: updated-ops-file
- name: update-windows2019fs-offline-release
  serial: true
  public: true
  plan:
  - in_parallel:
    - get: runtime-ci
    - get: relint-envs
    - get: cf-deployment-develop
    - get: cf-deployment-concourse-tasks
      params:
        tarball: false
    - get: windows2019fs-offline-release
      trigger: true
      params:
        tarball: false
    - get: windows2016-stemcell
  - task: update-windows-releases
    file: runtime-ci/tasks/update-single-opsfile-release/task.yml
    input_mapping:
      original-ops-file: cf-deployment-develop
      release: windows2019fs-offline-release
    params:
      RELEASE_NAME: windows2019fs
      ORIGINAL_OPS_FILE_PATH: operations/use-offline-windows2019fs.yml
      UPDATED_OPS_FILE_PATH: operations/use-offline-windows2019fs.yml
  - put: cf-deployment-develop
    params:
      rebase: true
      repository: updated-ops-file
- name: delete-stale-branches
  public: true
  plan:
  - in_parallel:
    - get: cf-deployment-all-branches
    - get: runtime-ci
    - get: daily
      trigger: true
  - task: delete-stale-branches
    file: runtime-ci/tasks/validate-branch-freshness/task.yml
    input_mapping:
      repo: cf-deployment-all-branches
    params:
      BRANCH_REGEXP: update-.*-release-.*
      MONTHS: 1
      DELETE_STALE_BRANCHES: true
      DEPLOY_KEY: ((cf_deployment_readwrite_deploy_key.private_key))
- name: setup-infrastructure-compilation
  serial: true
  public: true
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
  - task: setup-infrastructure
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_STATE_DIR: environments/test/greengrass/bbl-state
      BBL_CONFIG_DIR: environments/test/greengrass/bbl-config
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: environments/test/greengrass/google_account_creds.json
      BBL_GCP_REGION: us-central1
      BBL_LB_CERT: ((greengrass_cf_lb_cert.certificate))
      BBL_LB_KEY: ((greengrass_cf_lb_cert.private_key))
      LB_DOMAIN: greengrass.cf-app.com
      BBL_ENV_NAME: greengrass-compile
    input_mapping:
      bbl-state: relint-envs
      bbl-config: relint-envs
    ensure:
      put: relint-envs
      params:
        repository: updated-bbl-state
        rebase: true
  - task: extend-cloud-config-for-credhub-dry-run
    file: runtime-ci/tasks/bosh-extend-cloud-config/task.yml
    input_mapping:
      ops-file: relint-envs
      bbl-state: relint-envs
    params:
      BBL_STATE_DIR: environments/test/greengrass/bbl-state
      OPS_FILE_PATH: environments/test/greengrass/add-credhub-lb.yml
- name: destroy-infrastructure-compilation
  serial: true
  public: true
  plan:
  - in_parallel:
    - get: relint-envs
    - get: runtime-ci
    - get: cf-deployment-concourse-tasks
  - task: guarantee-no-existing-cf-deployment
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    input_mapping:
      bbl-state: relint-envs
    params:
      BBL_STATE_DIR: environments/test/greengrass/bbl-state
  - task: destroy-infrastructure
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    input_mapping:
      bbl-state: relint-envs
    params:
      BBL_STATE_DIR: environments/test/greengrass/bbl-state
      BBL_GCP_SERVICE_ACCOUNT_KEY: environments/test/greengrass/google_account_creds.json
    ensure:
      put: relint-envs
      params:
        repository: updated-bbl-state
        rebase: true
- name: run-bosh-cleanup-compilation
  serial: true
  public: true
  plan:
  - timeout: 4h
    do:
    - in_parallel:
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-develop
      - get: relint-envs
      - get: daily
        trigger: true
    - task: run-bosh-cleanup
      file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
      input_mapping:
        bbl-state: relint-envs
      params:
        BBL_STATE_DIR: environments/test/greengrass/bbl-state
    - task: upload-stemcell
      file: cf-deployment-concourse-tasks/bosh-upload-stemcells/task.yml
      input_mapping:
        bbl-state: relint-envs
        cf-deployment: cf-deployment-develop
        ops-files: cf-deployment-develop
      params:
        BBL_STATE_DIR: environments/test/greengrass/bbl-state
        INFRASTRUCTURE: google
        OPS_FILES: |
          operations/windows2012R2-cell.yml
          operations/windows2016-cell.yml
          operations/windows1803-cell.yml
          operations/windows2019-cell.yml
    - task: upload-bosh-dns-release
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: relintdockerhubpushbot/cf-deployment-concourse-tasks
            tag: latest
        inputs:
        - name: relint-envs
        run:
          path: /bin/bash
          args:
          - -c
          - |
            #!/bin/bash
            cd relint-envs/environments/test/greengrass/bbl-state
            eval "$(bbl print-env)"
            bosh upload-release $(bosh int <(bosh runtime-config --name=dns) --path /releases/name=bosh-dns/url)
